<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Related GANs and their SRGAN ablation experiments | 机器学习小纵队</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-test-site.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-test-site.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/blog/12-Related GANs and their SRGAN ablation experiments"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Related GANs and their SRGAN ablation experiments | 机器学习小纵队"><meta data-rh="true" name="description" content="本文将从三部分，即 GAN 模型的理论部分，代码（实践）部分及 SRGAN 的消融试验部分展开介绍"><meta data-rh="true" property="og:description" content="本文将从三部分，即 GAN 模型的理论部分，代码（实践）部分及 SRGAN 的消融试验部分展开介绍"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-06-16T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/zqqqqqqj1110"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/blog/12-Related GANs and their SRGAN ablation experiments"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/12-Related GANs and their SRGAN ablation experiments" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/12-Related GANs and their SRGAN ablation experiments" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="机器学习小纵队 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="机器学习小纵队 Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.cfd9dc83.css">
<script src="/assets/js/runtime~main.ade212af.js" defer="defer"></script>
<script src="/assets/js/main.10222ec2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="机器学习小纵队" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/favicon.ico" alt="机器学习小纵队" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">机器学习小纵队</b></a><a class="navbar__item navbar__link" href="/docs/ch0/FEMATHS-wiki-introduction">计算数学以及机器学习Wiki</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">FEMATHS小组学习日志</a><a class="navbar__item navbar__link" href="/members">FEMATHS小组成员</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/FEMATHS" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/18-HomPINNs_Homotopy_physics-informed_neural_networks_for_learning_multiple_solutions_of_nonlinear_elliptic_differential_equations">HomPINNs: Homotopy physics-informed neural networks for learning multiple solutions of nonlinear elliptic differential equations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/17-An_efficient_neural-network_and_finite-difference_hybrid_method_for_elliptic_interface_problems_with_applications">An efficient neural-network and finite-difference hybrid  method for elliptic interface problems with applications</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/16-A_new_analytical_formula_for_the_wave_equations_with_variable_coefficients">A new analytical formula for the wave equations with variable coefficients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/15-Novel_and_general_discontinuity-removing_PINNs_for_elliptic_interface_problems">Novel and general discontinuity-removing PINNs for elliptic interface problems</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/14-DeepONet_Learning_nonlinear_operators_for_identifying">DeepONet: Learning nonlinear operators for identifying differential equations based on the universal approximation theorem of operators</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/13-Deep Learning-Based Numerical Methods for High-Dimensional Parabolic Partial Differential Equations and Backward Stochastic Differential Equations">Machine learning based spectral methods for partial differential equations</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/12-Related GANs and their SRGAN ablation experiments">Related GANs and their SRGAN ablation experiments</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/05-Automated and Context-Aware Repair of Color-Related Accessibility Issues for Android Apps">Automated and Context-Aware Repair of Color-Related Accessibility Issues for Android Apps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/00-Ahead-of-our-research-efforts">欢迎来到FEMATHS小组学习日志</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/01-how-to-find-good-research-paper">从入门到入土？不，是精通！科技论文完全指南：如何找到一篇合适的科技论文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/02-how-to-read-research-paper">从入门到入土？不，是精通！科技论文完全指南：如何正确且高效地阅读一篇科技论文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/03-how-to-write-research-paper">从入门到入土？不，是精通！科技论文完全指南：如何写出一篇优秀的科技论文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/06-Bioinformatic analysis1（Linux Operation Guide）">Bioinformatic analysis:linux操作指南之上游分析(Part 1)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/07-Bioinformatic analysis2（Quality control and clustering）">Bioinformatic analysis:质量控制与聚类分析(Part 2)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/08-Bioinformatic analysis3（Differential genes and cell labeling）">Bioinformatic analysis:差异基因与细胞标注(Part3)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/09-Bioinformatic analysis4（Enrichment analysis）">Bioinformatic analysis:富集分析 (Part4)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/10-Bioinformatic analysis5（PPI and FT Analysis）">Bioinformatic analysis:PPI分析(Part 5)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/11-Bioinformatic analysis6（Sequential analysis）">Bioinformatic analysis:拟时序分析(Part 6)</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/04-Physics-Informed-Deep-Learning-Part-one">Physics Informed Deep Learning (Part I) Data-driven  Solutions of Nonlinear Partial Differential Equations</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Related GANs and their SRGAN ablation experiments</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-06-16T00:00:00.000Z">June 16, 2025</time> · <!-- -->22 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/zqqqqqqj1110" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/95482898?v=4" alt="zqqqj"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/zqqqqqqj1110" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">zqqqj</span></a></div><small class="authorTitle_nd0D" title="super bug engineer 4 nlp,robot,cv,ml and ds">super bug engineer 4 nlp,robot,cv,ml and ds</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>本文将从三部分，即 GAN 模型的理论部分，代码（实践）部分及 SRGAN 的消融试验部分展开介绍</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-gangenerative-adversarial-network生成对抗网络">1. GAN（Generative Adversarial Network）生成对抗网络<a href="#1-gangenerative-adversarial-network生成对抗网络" class="hash-link" aria-label="Direct link to 1. GAN（Generative Adversarial Network）生成对抗网络" title="Direct link to 1. GAN（Generative Adversarial Network）生成对抗网络">​</a></h2>
<p>核心：由两个神经网络——生成器（Generator）和判别器（Discriminator）组成，通过博弈过程相互提升。
· 生成器：试图“伪造”以假乱真的数据。
· 判别器：判断输入是真实数据还是生成器伪造的。
· 训练目标：生成器希望骗过判别器，判别器希望准确识别真假。
本质上是一个最大最小问题：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munder><mrow><mi>min</mi><mo>⁡</mo></mrow><mi>G</mi></munder><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>D</mi></munder><mtext> </mtext><msub><mi mathvariant="double-struck">E</mi><mrow><mi>x</mi><mo>∼</mo><msub><mi>p</mi><mtext>data</mtext></msub></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><mo>⁡</mo><mi>D</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow><mo>+</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi>z</mi><mo>∼</mo><msub><mi>p</mi><mi>z</mi></msub></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mn>1</mn><mo>−</mo><mi>D</mi><mo stretchy="false">(</mo><mi>G</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\min_G \max_D \ \mathbb{E}_{x \sim p_{\text{data}}} \left[ \log D(x) \right] + \mathbb{E}_{z \sim p_z} \left[ \log \left(1 - D(G(z)) \right) \right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4943em;vertical-align:-0.7443em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em"><span style="top:-2.3557em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">G</span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7443em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em"><span style="top:-2.3557em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">D</span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7443em"><span></span></span></span></span></span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">data</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">[</span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em">]</span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">[</span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">))</span><span class="mclose delimcenter" style="top:0em">)</span></span><span class="mclose delimcenter" style="top:0em">]</span></span></span></span></span></span>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-cganconditional-gan条件生成对抗网络">2. cGAN（Conditional GAN）条件生成对抗网络<a href="#2-cganconditional-gan条件生成对抗网络" class="hash-link" aria-label="Direct link to 2. cGAN（Conditional GAN）条件生成对抗网络" title="Direct link to 2. cGAN（Conditional GAN）条件生成对抗网络">​</a></h2>
<p>核心：在 GAN 的基础上，引入“条件”信息（如标签、图像、文本等）
· 生成器和判别器都接收条件变量
· G（z，y）：在条件 y 下生成图像
· D（x，y）：判断图像是否为在条件 y 下真实的
用途：图像翻译（如黑白图像上色）、语义图生成图像、文本生成图像
目标函数：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munder><mrow><mi>min</mi><mo>⁡</mo></mrow><mi>G</mi></munder><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>D</mi></munder><mtext> </mtext><msub><mi mathvariant="double-struck">E</mi><mrow><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>∼</mo><msub><mi>p</mi><mtext>data</mtext></msub></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><mo>⁡</mo><mi>D</mi><mo stretchy="false">(</mo><mi>x</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow><mo>+</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi>z</mi><mo>∼</mo><msub><mi>p</mi><mi>z</mi></msub></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mn>1</mn><mo>−</mo><mi>D</mi><mo stretchy="false">(</mo><mi>G</mi><mo stretchy="false">(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\min_G \max_D \ \mathbb{E}_{x,y \sim p_{\text{data}}} \left[ \log D(x|y) \right] + \mathbb{E}_{z \sim p_z} \left[ \log \left(1 - D(G(z|y)) \right) \right]

</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4943em;vertical-align:-0.7443em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em"><span style="top:-2.3557em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">G</span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7443em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em"><span style="top:-2.3557em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">D</span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7443em"><span></span></span></span></span></span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">data</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">[</span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em">]</span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">[</span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mclose">))</span><span class="mclose delimcenter" style="top:0em">)</span></span><span class="mclose delimcenter" style="top:0em">]</span></span></span></span></span></span>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-srgan">3. SRGAN<a href="#3-srgan" class="hash-link" aria-label="Direct link to 3. SRGAN" title="Direct link to 3. SRGAN">​</a></h2>
<p>目的：图像超分辨率，即将低分辨率图像（LR）还原成高分辨率图像（HR）
· 生成器结构：使用残差网络（ResNet）进行细节重建。
· 判别器：区分生成的高分图像和真实高分图像。
损失函数包含：
· 内容损失（如 MSE 或感知损失）；
· 对抗损失（判别器输出）
· 感知损失（Perceptual Loss）：在 VGG 网络的高层 feature 上计算差异，更贴近人类视觉感受</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-esrgan">4. ESRGAN<a href="#4-esrgan" class="hash-link" aria-label="Direct link to 4. ESRGAN" title="Direct link to 4. ESRGAN">​</a></h2>
<p>基于 SRGAN，具有如下优势：</p>
<ol>
<li>Residual-in-Residual Dense Block (RRDB)：替换原 SRGAN 的残差块，结构更深，信息流更丰富。</li>
<li>对抗损失改进：采用 Relativistic average GAN（RaGAN），即判断“生成图是否比真实图更假”，而不是简单判断真假。</li>
<li>感知损失优化：使用未归一化的 VGG 特征图，避免图像过光滑。</li>
<li>训练技巧：使用多阶段训练，包括先训练内容损失，再加入对抗训练</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结理论部分">总结（理论部分）<a href="#总结理论部分" class="hash-link" aria-label="Direct link to 总结（理论部分）" title="Direct link to 总结（理论部分）">​</a></h2>
<table><thead><tr><th>名称</th><th>全称</th><th>类型</th><th>特点概述</th></tr></thead><tbody><tr><td>GAN</td><td>Generative Adversarial Net</td><td>无监督生成</td><td>对抗生成图像</td></tr><tr><td>cGAN</td><td>Conditional GAN</td><td>条件生成</td><td>加入标签或条件进行控制</td></tr><tr><td>SRGAN</td><td>Super-Resolution GAN</td><td>图像超分辨率</td><td>使用感知损失，生成自然高分图像</td></tr><tr><td>ESRGAN</td><td>Enhanced SRGAN</td><td>图像超分辨率</td><td>加强网络结构和损失函数，细节更佳</td></tr></tbody></table>
<p><strong>在后文的试验中，原始代码与数据集皆存放在 GitHub 仓库：<a href="https://github.com/zqqqqqqj1110/GAN_WB" target="_blank" rel="noopener noreferrer">https://github.com/zqqqqqqj1110/GAN_WB</a></strong></p>
<h1>GAN 对抗神经网络及其变种（试验部分）</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-cgan">1. cGAN<a href="#1-cgan" class="hash-link" aria-label="Direct link to 1. cGAN" title="Direct link to 1. cGAN">​</a></h2>
<p>本文以 cGAN 作为 baseline，后续的 gan 变种模型皆由该部分代码变换而来，因此在这部分会讲的较为全面一些，后文可能会省略</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-安装需要的包与环境">1.1 安装需要的包与环境<a href="#11-安装需要的包与环境" class="hash-link" aria-label="Direct link to 1.1 安装需要的包与环境" title="Direct link to 1.1 安装需要的包与环境">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import pandas as pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import torch.nn as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import torch.nn.functional as F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import torch.optim as optim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from torch.utils.data import Dataset, DataLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from skimage.metrics import peak_signal_noise_ratio, structural_similarity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import matplotlib.pyplot as plt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from pytorch_msssim import ms_ssim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">device = torch.device(&quot;mps&quot; if torch.backends.mps.is_available() else &quot;cpu&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(device)</span><br></span></code></pre></div></div>
<p>作者使用的是 MacOS，因此使用了 mps，如果是 cuda 的话直接换成“cuda”即可，配置环境部分（gpu 环境）可转到我的个人博客处查阅（或者在这更，懒了，小鸽一下^_^）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-数据预处理">1.2 数据预处理<a href="#12-数据预处理" class="hash-link" aria-label="Direct link to 1.2 数据预处理" title="Direct link to 1.2 数据预处理">​</a></h3>
<p>首先需要加载原始的数据集，接着在低分辨率下生成数据（下采样）与保存（通过双线性插值的方法），最后计算 mean，std 等标准指标（都是后面需要用到的，为了计算指标，不如手动自己计算一下）</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># === 1. 加载原始 HR 数据 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hr_train = np.load(&quot;seasonal_split/HR_data_train_tm_Summer.npy&quot;)[:200]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hr_valid = np.load(&quot;seasonal_split/HR_data_valid_tm_Summer.npy&quot;)[:200]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hr_test = np.load(&quot;seasonal_split/HR_data_test_tm_Summer.npy&quot;)[:200]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === 2. 生成 LR 数据（双线性插值至 16×16） ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def downsample(hr_array, scale=4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tensor = torch.tensor(hr_array, dtype=torch.float32)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return F.interpolate(tensor, scale_factor=1/scale, mode=&quot;bilinear&quot;, align_corners=False).numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lr_train = downsample(hr_train)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lr_valid = downsample(hr_valid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lr_test = downsample(hr_test)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === 3. 保存为 .npy 文件 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/HR_data_train_40.npy&quot;, hr_train)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/LR_data_train_40.npy&quot;, lr_train)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/HR_data_valid_40.npy&quot;, hr_valid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/LR_data_valid_40.npy&quot;, lr_valid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/HR_data_test_40.npy&quot;, hr_test)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/LR_data_test_40.npy&quot;, lr_test)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === 4. mean和std===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean = np.mean(hr_train, axis=(0, 2, 3))[:, None, None]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std = np.std(hr_train, axis=(0, 2, 3))[:, None, None]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/mean_40.npy&quot;, mean)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/std_40.npy&quot;, std)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 每个通道的 min 和 max（例如 2 个通道）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hr_min = hr_train.min(axis=(0, 2, 3))  # shape: (2,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hr_max = hr_train.max(axis=(0, 2, 3))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 保存为 .npy 文件，后续评估使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/min_40.npy&quot;, hr_min.astype(np.float32))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;tm/max_40.npy&quot;, hr_max.astype(np.float32))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(&quot;完成：生成 LR/HR 切片、保存归一化参数，包括 test&quot;)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-自定义数据集类">1.3 自定义数据集类<a href="#13-自定义数据集类" class="hash-link" aria-label="Direct link to 1.3 自定义数据集类" title="Direct link to 1.3 自定 义数据集类">​</a></h3>
<p>为了后续方便训练，自定义数据集类，主要是为了变形等操作。最终目的是对每张图进行归一化（标准化）并用于 DataLoader 加载训练/验证数据</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class WeatherDataset(Dataset):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, lr_path, hr_path, mean_path, std_path):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.lr = np.load(lr_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hr = np.load(hr_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mean = np.load(mean_path).reshape(2, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.std = np.load(std_path).reshape(2, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __len__(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return len(self.lr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __getitem__(self, idx):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lr = (self.lr[idx] - self.mean) / self.std</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hr = (self.hr[idx] - self.mean) / self.std</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return torch.tensor(lr, dtype=torch.float32), torch.tensor(hr, dtype=torch.float32)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="14-定义生成器">1.4 定义生成器<a href="#14-定义生成器" class="hash-link" aria-label="Direct link to 1.4 定义生成器" title="Direct link to 1.4 定义生成器">​</a></h3>
<p>定义 cGAN 等生成器部分，编码器通过两层卷积和 LeakyReLU 将输入图像从 16×16 压缩至 4×4，用于提取深层特征；解码器则通过四层反卷积（ConvTranspose）逐步上采样回 64×64，同时使用 BatchNorm 和 ReLU 激活保持稳定性和非线性表达能力。最终一层使用 Tanh 激活输出高分辨率图像</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class GeneratorUNet(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, in_channels=2, out_channels=2, features=64):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.encoder = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(in_channels, features, 4, 2, 1),  # 16×16 → 8×8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 2, 4, 2, 1),  # 8×8 → 4×4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features * 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.decoder = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.ConvTranspose2d(features * 2, features, 4, 2, 1),  # 4×4 → 8×8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.ReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.ConvTranspose2d(features, features, 4, 2, 1),  # 8×8 → 16×16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.ReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.ConvTranspose2d(features, features, 4, 2, 1),  # 16×16 → 32×32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.ReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.ConvTranspose2d(features, out_channels, 4, 2, 1),  # 32×32 → 64×64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Tanh()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.decoder(self.encoder(x))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="15-定义判别器">1.5 定义判别器<a href="#15-定义判别器" class="hash-link" aria-label="Direct link to 1.5 定义判别器" title="Direct link to 1.5 定义判别器">​</a></h3>
<p>使用多个卷积层对输入图像局部区域进行真实性判别，输入为上采样后的 LR 图像与真实/生成 HR 图像的拼接结果。网络逐层下采样并输出一个 7×7 的判别图，对图像中各个局部 patch 给出是否真实的预测评分</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import torch.nn as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Discriminator(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, in_channels=4, features=64):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(in_channels, features, 4, 2, 1),  # (B, 64, 32, 32)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 2, 4, 2, 1),  # (B, 128, 16, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features * 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features * 2, features * 4, 4, 2, 1),  # (B, 256, 8, 8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features * 4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features * 4, 1, 4, 1, 1),  # (B, 1, 7, 7) =&gt; PatchGAN 输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Sigmoid()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, lr_up, hr_or_fake):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ensure both inputs are [B, 2, 64, 64]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if lr_up.shape[-2:] != hr_or_fake.shape[-2:]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            raise ValueError(f&quot;Shape mismatch: lr_up={lr_up.shape}, hr={hr_or_fake.shape}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x = torch.cat([lr_up, hr_or_fake], dim=1)  # =&gt; [B, 4, H, W]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.model(x)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="16-计算指标">1.6 计算指标<a href="#16-计算指标" class="hash-link" aria-label="Direct link to 1.6 计算指标" title="Direct link to 1.6 计算指标">​</a></h3>
<p>本文以 SSIM，PSNR 为例，对模型进行评估，需要注意的是归一化不应该是 z-score，而是应该使用 max-min 归一化（吃过一次亏）</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from skimage.metrics import peak_signal_noise_ratio, structural_similarity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import torch.nn.functional as F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def compute_psnr_ssim(pred, target):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 转换为 numpy 格式，shape: (N, H, W, C)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pred = pred.detach().cpu().numpy().transpose(0, 2, 3, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    target = target.detach().cpu().numpy().transpose(0, 2, 3, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_range = max(target.max(), pred.max()) - min(target.min(), pred.min())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    psnr_total, ssim_total = 0, 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for p, t in zip(pred, target):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        psnr_total += peak_signal_noise_ratio(t, p, data_range=data_range)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssim_total += structural_similarity(t, p, channel_axis=-1, data_range=data_range)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return psnr_total / len(pred), ssim_total / len(pred)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def compute_rmse(pred, target):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return torch.sqrt(torch.mean((pred - target) ** 2))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def compute_mae(pred, target):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return torch.mean(torch.abs(pred - target))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === 添加 SSIM Loss ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def ssim_loss(pred, target, C1=0.01**2, C2=0.03**2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mu_x = F.avg_pool2d(pred, 3, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mu_y = F.avg_pool2d(target, 3, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sigma_x = F.avg_pool2d(pred ** 2, 3, 1, 1) - mu_x ** 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sigma_y = F.avg_pool2d(target ** 2, 3, 1, 1) - mu_y ** 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sigma_xy = F.avg_pool2d(pred * target, 3, 1, 1) - mu_x * mu_y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssim_n = (2 * mu_x * mu_y + C1) * (2 * sigma_xy + C2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssim_d = (mu_x ** 2 + mu_y ** 2 + C1) * (sigma_x + sigma_y + C2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssim_map = ssim_n / (ssim_d + 1e-8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 1 - ssim_map.mean()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 加载 min/max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hr_min = np.load(&quot;tm/min_40.npy&quot;)[:, None, None]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hr_max = np.load(&quot;tm/max_40.npy&quot;)[:, None, None]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def minmax_scale(tensor):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 缩放到 0~1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (tensor - torch.tensor(hr_min, dtype=torch.float32).to(tensor.device)) / \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           (torch.tensor(hr_max - hr_min, dtype=torch.float32).to(tensor.device))</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="17-加载数据集准备训练">1.7 加载数据集，准备训练<a href="#17-加载数据集准备训练" class="hash-link" aria-label="Direct link to 1.7 加载数据集，准备训练" title="Direct link to 1.7 加载数据集，准备训练">​</a></h3>
<p>batch size 为将 n 个样本为一组（一个批次）读取数据.将之前的训练集，测试集与评估集上传到数据类并加载，准备训练。需要注意的是 batch size 越大，对 gpu 的负担也越大，但是同时训练到的数据也越多</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">train_set = WeatherDataset(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;tm/LR_data_train_40.npy&quot;, &quot;tm/HR_data_train_40.npy&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;tm/mean_40.npy&quot;, &quot;tm/std_40.npy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val_set = WeatherDataset(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;tm/LR_data_valid_40.npy&quot;, &quot;tm/HR_data_valid_40.npy&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;tm/mean_40.npy&quot;, &quot;tm/std_40.npy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_set = WeatherDataset(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;tm/LR_data_test_40.npy&quot;, &quot;tm/HR_data_test_40.npy&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;tm/mean_40.npy&quot;, &quot;tm/std_40.npy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_loader = DataLoader(test_set, batch_size=32, shuffle=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">train_loader = DataLoader(train_set, batch_size=32, shuffle=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val_loader = DataLoader(val_set, batch_size=32, shuffle=False)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="18-模型训练">1.8 模型训练<a href="#18-模型训练" class="hash-link" aria-label="Direct link to 1.8 模型训练" title="Direct link to 1.8 模型训练">​</a></h3>
<p>首先先对模型进行初始化，最后一句 print 为形状，如果形状不对后续训练必失败。实例化生成器和判别器并送到设备（MPS 或 CPU）；接着定义损失函数，MSELoss 用于像素级内容损失，BCELoss 用于 GAN 判别器对抗损失；最后定义优化器，使用 ADAM 进行优化并将学习率调为 1e-4</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># === 6. Model Initialization ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">G = GeneratorUNet().to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D = Discriminator().to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">criterion_GAN = nn.BCEWithLogitsLoss()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">criterion_L1 = nn.L1Loss()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">opt_G = torch.optim.Adam(G.parameters(), lr=1e-4, betas=(0.5, 0.999), weight_decay=1e-4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">opt_D = torch.optim.Adam(D.parameters(), lr=1e-4, betas=(0.5, 0.999), weight_decay=1e-4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">with torch.no_grad():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dummy_input = torch.randn(1, 2, 16, 16).to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dummy_output = G(dummy_input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;G output shape: {dummy_output.shape}&quot;)  # 应该是 [1, 2, 64, 64]</span><br></span></code></pre></div></div>
<p>准备好了之后，最后开始进行模型的训练与保存，训练时可以将每一轮 epoch 的指标都保存在数组中，方便后续画图；还需要注意在训练前准备标签构造，为对抗训练准备真假标签（用于 BCELoss）且判别器输出是 6×6 patch 的预测，匹配标签形状。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">num_epochs = 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">train_psnrs, train_ssims, train_rmses, train_maes = [], [], [], []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val_psnrs, val_ssims, val_rmses, val_maes = [], [], [], []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for epoch in range(num_epochs):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    G.train()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for lr, hr in train_loader:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lr, hr = lr.to(device), hr.to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # === Forward Generator ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fake = G(lr).to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lr_up = F.interpolate(lr, size=hr.shape[-2:], mode=&quot;bilinear&quot;, align_corners=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # === Train Discriminator ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        D_real = D(lr_up, hr).to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        D_fake = D(lr_up, fake.detach()).to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss_D = (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            criterion_GAN(D_real, torch.ones_like(D_real)) +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            criterion_GAN(D_fake, torch.zeros_like(D_fake))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) * 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        opt_D.zero_grad()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss_D.backward()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        opt_D.step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # === Train Generator ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred = D(lr_up, fake)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss_ssim = ssim_loss(fake, hr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss_l1 = criterion_L1(fake, hr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss_gan = criterion_GAN(pred, torch.ones_like(pred))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss_G = 0.01 * loss_gan + 1.0 * loss_ssim + 1.0 * loss_l1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        opt_G.zero_grad()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss_G.backward()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        opt_G.step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_pred = G(lr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_pred = F.interpolate(train_pred, size=hr.shape[-2:], mode=&quot;bilinear&quot;, align_corners=False).to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 评估</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_pred_mm = minmax_scale(train_pred)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hr_mm = minmax_scale(hr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    psnr_train, ssim_train = compute_psnr_ssim(train_pred, hr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmse_train = compute_rmse(train_pred_mm, hr_mm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mae_train = compute_mae(train_pred_mm, hr_mm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 添加保存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_psnrs.append(psnr_train)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_ssims.append(ssim_train)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_rmses.append(rmse_train)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_maes.append(mae_train)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    G.eval()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    with torch.no_grad():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val_lr, val_hr = next(iter(val_loader))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val_lr, val_hr = val_lr.to(device), val_hr.to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_hr = G(val_lr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_hr = F.interpolate(pred_hr, size=val_hr.shape[-2:], mode=&quot;bilinear&quot;, align_corners=False).to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算指标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_val_mm = minmax_scale(pred_hr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val_hr_mm = minmax_scale(val_hr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        psnr_val, ssim_val = compute_psnr_ssim(pred_hr, val_hr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rmse_val = compute_rmse(pred_val_mm, val_hr_mm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mae_val = compute_mae(pred_val_mm, val_hr_mm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 添加保存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val_psnrs.append(psnr_val)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val_ssims.append(ssim_val)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val_rmses.append(rmse_val)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val_maes.append(mae_val)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # === Print summary ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;Epoch {epoch+1}: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          f&quot;Train PSNR={psnr_train:.2f}, SSIM={ssim_train:.4f}, RMSE={rmse_train:.4f}, MAE={mae_train:.4f} | &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          f&quot;Valid PSNR={psnr_val:.2f}, SSIM={ssim_val:.4f}, RMSE={rmse_val:.4f}, MAE={mae_val:.4f}&quot;)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="19-模型验证">1.9 模型验证<a href="#19-模型验证" class="hash-link" aria-label="Direct link to 1.9 模型验证" title="Direct link to 1.9 模型验证">​</a></h3>
<p>训练完了之后对保存好了的模型进行 test 验证，查看评估指标的表现</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import matplotlib.pyplot as plt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from torch.utils.data import DataLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === 1. 加载测试集 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_set = WeatherDataset(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;tm/LR_data_test_40.npy&quot;, &quot;tm/HR_data_test_40.npy&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;tm/mean_40.npy&quot;, &quot;tm/std_40.npy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_loader = DataLoader(test_set, batch_size=8, shuffle=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === 2. 在测试集上评估模型 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">G.eval()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_psnrs, test_ssims, test_rmses, test_maes = [], [], [], []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">images_to_show = []  # 原图、真实图、预测图（反归一化后）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 反归一化函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean = np.load(&quot;tm/mean_40.npy&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std = np.load(&quot;tm/std_40.npy&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def denormalize(tensor):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return tensor * torch.tensor(std).to(tensor.device) + torch.tensor(mean).to(tensor.device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">with torch.no_grad():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for test_lr, test_hr in test_loader:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        test_lr, test_hr = test_lr.to(device), test_hr.to(device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_test = G(test_lr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_test = F.interpolate(pred_test, size=test_hr.shape[-2:], mode=&quot;bilinear&quot;, align_corners=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算指标（归一化下）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_mm = minmax_scale(pred_test)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hr_mm = minmax_scale(test_hr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        psnr, ssim = compute_psnr_ssim(pred_test, test_hr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rmse = compute_rmse(pred_mm, hr_mm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mae = compute_mae(pred_mm, hr_mm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        test_psnrs.append(psnr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        test_ssims.append(ssim)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        test_rmses.append(rmse.cpu().item())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        test_maes.append(mae.cpu().item())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 可视化：选取前1张图，反归一化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lr_img = F.interpolate(test_lr[i:i+1], size=(64, 64), mode=&quot;bilinear&quot;, align_corners=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            images_to_show.append((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                denormalize(lr_img[0].cpu()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                denormalize(test_hr[i].cpu()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                denormalize(pred_test[i].cpu())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === 3. 打印测试集平均指标 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(f&quot;Test Set Evaluation cGAN Winter:&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(f&quot;PSNR: {np.mean(test_psnrs):.2f}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(f&quot;SSIM: {np.mean(test_ssims):.4f}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(f&quot;RMSE: {np.mean(test_rmses):.4f}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(f&quot;MAE: {np.mean(test_maes):.4f}&quot;)</span><br></span></code></pre></div></div>
<hr>
<p><strong>常用指标计算公式</strong></p>
<ol>
<li>PSNR（峰值信噪比）</li>
</ol>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>PSNR</mtext><mo>=</mo><mn>10</mn><mo>⋅</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>10</mn></msub><mrow><mo fence="true">(</mo><mfrac><mrow><mi>M</mi><mi>A</mi><msup><mi>X</mi><mn>2</mn></msup></mrow><mtext>MSE</mtext></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{PSNR} = 10 \cdot \log_{10} \left( \frac{MAX^2}{\text{MSE}} \right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">PSNR</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:2.4411em;vertical-align:-0.95em"></span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em"><span style="top:-2.4559em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord text"><span class="mord">MSE</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em">M</span><span class="mord mathnormal">A</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em"><span class="delimsizing size3">)</span></span></span></span></span></span></span>
<hr>
<ol start="2">
<li>SSIM（结构相似性）</li>
</ol>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>SSIM</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><msub><mi>μ</mi><mi>x</mi></msub><msub><mi>μ</mi><mi>y</mi></msub><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><msub><mi>σ</mi><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><msubsup><mi>μ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msubsup><mi>σ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{SSIM}(x, y) = \frac{(2\mu_x \mu_y + C_1)(2\sigma_{xy} + C_2)}{(\mu_x^2 + \mu_y^2 + C_1)(\sigma_x^2 + \sigma_y^2 + C_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord text"><span class="mord">SSIM</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.4961em;vertical-align:-1.0691em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401em"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span><span style="top:-2.989em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401em"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span><span style="top:-2.989em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401em"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span><span style="top:-2.989em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401em"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span><span style="top:-2.989em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0691em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<hr>
<ol start="3">
<li>RMSE（均方根误差）</li>
</ol>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>RMSE</mtext><mo>=</mo><msqrt><mrow><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">\text{RMSE} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (x_i - y_i)^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">RMSE</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:3.1568em;vertical-align:-1.2777em"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8791em"><span class="svg-align" style="top:-5.1168em"><span class="pstrut" style="height:5.1168em"></span><span class="mord" style="padding-left:1.056em"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em"><span style="top:-1.8723em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em"><span style="top:-2.989em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.8391em"><span class="pstrut" style="height:5.1168em"></span><span class="hide-tail" style="min-width:0.742em;height:3.1968em"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.1968em" viewBox="0 0 400000 3196" preserveAspectRatio="xMinYMin slice"><path d="M702 80H40000040
H742v3062l-4 4-4 4c-.667.7 -2 1.5-4 2.5s-4.167 1.833-6.5 2.5-5.5 1-9.5 1
h-12l-28-84c-16.667-52-96.667 -294.333-240-727l-212 -643 -85 170
c-4-3.333-8.333-7.667-13 -13l-13-13l77-155 77-156c66 199.333 139 419.667
219 661 l218 661zM702 80H400000v40H742z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em"><span></span></span></span></span></span></span></span></span></span>
<hr>
<ol start="4">
<li>MAE（平均绝对误差）</li>
</ol>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MAE</mtext><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">\text{MAE} = \frac{1}{n} \sum_{i=1}^{n} |x_i - y_i|
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">MAE</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em"><span style="top:-1.8723em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">∣</span></span></span></span></span>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="110-保存">1.10 保存<a href="#110-保存" class="hash-link" aria-label="Direct link to 1.10 保存" title="Direct link to 1.10 保存">​</a></h3>
<p>这部分就不多说了，提供一下评估指标的保存方式，接着想可视化等等皆可</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 将数组保存为 .npy 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;1_ssim_train.npy&quot;, train_ssims)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;1_psnr_train.npy&quot;, train_psnrs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;1_ssim_valid.npy&quot;, val_ssims)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;1_psnr_valid.npy&quot;, val_psnrs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(&quot;✅ 已保存为 1_ssim_train.npy, 1_psnr_train.npy, 1_ssim_valid.npy, 1_psnr_valid.npy&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 确保每个 tensor 都通过 .detach() 断开计算图，之后转移到 CPU 并转换为 NumPy 数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">train_maes_cpu = [mae.detach().cpu().numpy() for mae in train_maes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">train_rmses_cpu = [rmse.detach().cpu().numpy() for rmse in train_rmses]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">valid_maes_cpu = [mae.detach().cpu().numpy() for mae in val_maes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">valid_rmses_cpu = [rmse.detach().cpu().numpy() for rmse in val_rmses]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 保存为 .npy 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;1_mae_train.npy&quot;, train_maes_cpu)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;1_rmes_train.npy&quot;, train_rmses_cpu)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;1_mae_valid.npy&quot;, valid_maes_cpu)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np.save(&quot;1_rmes_valid.npy&quot;, valid_rmses_cpu)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># .npy 文件的列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;1_mae_train.npy&quot;, &quot;1_mae_valid.npy&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;1_psnr_train.npy&quot;, &quot;1_psnr_valid.npy&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;1_rmes_train.npy&quot;, &quot;1_rmes_valid.npy&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;1_ssim_train.npy&quot;, &quot;1_ssim_valid.npy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建一个字典来存储数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_dict = {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 加载每个 .npy 文件并存入字典</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for file in files:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_dict[file] = np.load(file)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将字典转换为 pandas DataFrame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df = pd.DataFrame(data_dict)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将 DataFrame 保存为 CSV 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df.to_csv(&quot;cGAN_data_Winter.csv&quot;, index=False)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-srgan">2. SRGAN<a href="#2-srgan" class="hash-link" aria-label="Direct link to 2. SRGAN" title="Direct link to 2. SRGAN">​</a></h2>
<p>大部分可类比过来，具体就去看原代码，这里就讲一些不一样的部分，比如说生成器与判别器</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-生成器模型-srresnetgenerator">2.1 生成器模型 SRResNetGenerator<a href="#21-生成器模型-srresnetgenerator" class="hash-link" aria-label="Direct link to 2.1 生成器模型 SRResNetGenerator" title="Direct link to 2.1 生成器模型 SRResNetGenerator">​</a></h3>
<p>该网络基本结构模仿 SRResNet，内含：
· Initial Layer：9x9 大卷积核 + PReLU
· 8 个残差块（每块带有两层卷积 + BN + PReLU）
· 残差连接（ResNet 风格）
上采样层：
· 使用 PixelShuffle 实现图像上采样（从 16x16 → 64x64）
· 最终卷积 + Tanh：输出范围规范为 [-1, 1]</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class SRResNetGenerator(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, in_channels=2, out_channels=2, features=64):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.initial = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(in_channels, features, kernel_size=9, padding=4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PReLU()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 8 Residual Blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        res_blocks = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for _ in range(8):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res_blocks.append(nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.Conv2d(features, features, kernel_size=3, padding=1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.BatchNorm2d(features),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.PReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.Conv2d(features, features, kernel_size=3, padding=1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.BatchNorm2d(features)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.res_blocks = nn.Sequential(*res_blocks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mid_conv = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features, kernel_size=3, padding=1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.upsample = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 4, 3, 1, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PixelShuffle(2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 4, 3, 1, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PixelShuffle(2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.final = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, out_channels, kernel_size=9, padding=4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Tanh()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1 = self.initial(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        res = x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for block in self.res_blocks:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = res + block(res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.mid_conv(res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = out + x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.upsample(out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.final(out)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-定义判别器-discriminator">2.2 定义判别器 Discriminator<a href="#22-定义判别器-discriminator" class="hash-link" aria-label="Direct link to 2.2 定义判别器 Discriminator" title="Direct link to 2.2 定义判别器 Discriminator">​</a></h3>
<p>该判别器用于判断输入图像是否为真实高分图像，具体如下：
· 多层卷积+BN+LeakyReLU，最后输出为一个值
· 类似 PatchGAN 风格（结果为二维特征图）
· 最后一层采用 Sigmoid 激活，输出概率</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import torch.nn as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Discriminator(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, in_channels=4, features=64):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(in_channels, features, 4, 2, 1),  # (B, 64, 32, 32)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 2, 4, 2, 1),  # (B, 128, 16, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features * 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features * 2, features * 4, 4, 2, 1),  # (B, 256, 8, 8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features * 4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features * 4, 1, 4, 1, 1),  # (B, 1, 7, 7) =&gt; PatchGAN 输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Sigmoid()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, lr_up, hr_or_fake):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 确保为[B, 2, 64, 64]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if lr_up.shape[-2:] != hr_or_fake.shape[-2:]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            raise ValueError(f&quot;Shape mismatch: lr_up={lr_up.shape}, hr={hr_or_fake.shape}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x = torch.cat([lr_up, hr_or_fake], dim=1)  # [B, 4, H, W]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.model(x)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-esrgan">3. ESRGAN<a href="#3-esrgan" class="hash-link" aria-label="Direct link to 3. ESRGAN" title="Direct link to 3. ESRGAN">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-生成器模型-rdbnet">3.1 生成器模型 RDBNet<a href="#31-生成器模型-rdbnet" class="hash-link" aria-label="Direct link to 3.1 生成器模型 RDBNet" title="Direct link to 3.1 生成器模型 RDBNet">​</a></h3>
<p>使用多个 残差密集块（RRDB），用于深层次特征提取与稳定训练；每个 RRDB 由三个去 BN 的 DenseBlock 组成，通过局部和全局残差连接增强梯度传播、抑制信息丢失。整体流程为：输入图像经卷积提取初步特征 → 多层 RRDB 提取深层表示 → 上采样模块逐步恢复空间分辨率 → 最终输出</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import torch.nn as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Dense Block（去掉BN + 残差缩放）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DenseBlock(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, channels=64, growth_channels=32):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.layers = nn.ModuleList()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(5):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.layers.append(nn.Conv2d(channels + i * growth_channels, growth_channels, 3, 1, 1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.lrelu = nn.LeakyReLU(0.2, inplace=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.conv_last = nn.Conv2d(channels + 5 * growth_channels, channels, 3, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inputs = [x]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for conv in self.layers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            out = self.lrelu(conv(torch.cat(inputs, dim=1)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inputs.append(out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.conv_last(torch.cat(inputs, dim=1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return x + out * 0.2  # Local residual</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># RRDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class RRDB(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, channels, growth_channels=32):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.block1 = DenseBlock(channels, growth_channels)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.block2 = DenseBlock(channels, growth_channels)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.block3 = DenseBlock(channels, growth_channels)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.block1(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.block2(out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.block3(out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return x + out * 0.2  # Global residual</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ESRGAN Generator (RRDBNet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class RRDBNet(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, in_channels=2, out_channels=2, features=64, num_blocks=8):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.conv_first = nn.Conv2d(in_channels, features, 3, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # RRDB trunk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rrdb_blocks = nn.Sequential(*[RRDB(features) for _ in range(num_blocks)])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.trunk_conv = nn.Conv2d(features, features, 3, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Upsampling blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.upsample = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 4, 3, 1, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PixelShuffle(2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2, inplace=True),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 4, 3, 1, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PixelShuffle(2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.LeakyReLU(0.2, inplace=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.conv_last = nn.Conv2d(features, out_channels, 3, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fea = self.conv_first(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trunk = self.trunk_conv(self.rrdb_blocks(fea))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fea = fea + trunk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.upsample(fea)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.conv_last(out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-判别器模型-esrdiscriminator">3.2 判别器模型 ESRDiscriminator<a href="#32-判别器模型-esrdiscriminator" class="hash-link" aria-label="Direct link to 3.2 判别器模型 ESRDiscriminator" title="Direct link to 3.2 判别器模型 ESRDiscriminator">​</a></h3>
<p>ESRDiscriminator 是一个深层 PatchGAN 判别器，通过逐层卷积下采样提取图像局部特征，并对 LR 图像与 HR 图像的拼接输入进行真假判别</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class ESRDiscriminator(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, in_channels=4, base_features=64):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        def block(in_f, out_f, stride):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.Conv2d(in_f, out_f, 3, stride, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.LeakyReLU(0.2, inplace=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        layers = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            block(in_channels, base_features, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            block(base_features, base_features, 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            block(base_features, base_features * 2, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            block(base_features * 2, base_features * 2, 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            block(base_features * 2, base_features * 4, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            block(base_features * 4, base_features * 4, 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            block(base_features * 4, base_features * 8, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            block(base_features * 8, base_features * 8, 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(base_features * 8, 1, 3, 1, 1)  # PatchGAN 输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model = nn.Sequential(*layers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, lr_up, hr_or_fake):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if lr_up.shape[-2:] != hr_or_fake.shape[-2:]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            raise ValueError(f&quot;Shape mismatch: lr_up={lr_up.shape}, hr={hr_or_fake.shape}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x = torch.cat([lr_up, hr_or_fake], dim=1)  # 拼接输入 [B, 4, H, W]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.model(x)</span><br></span></code></pre></div></div>
<h1>SRGAN 及其消融试验</h1>
<p>以 SRGAN 为 baseline，本文对比了四种情况，即</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-损失函数改进版">1. 损失函数改进版<a href="#1-损失函数改进版" class="hash-link" aria-label="Direct link to 1. 损失函数改进版" title="Direct link to 1. 损失函数改进版">​</a></h2>
<p>除了使用传统的 MSE 和对抗损失，还使用了 VGG perceptual loss（基于 VGG 网络的中间层）；MS-SSIM（多尺度结构相似性指标）</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-通道注意力机制版">2. 通道注意力机制版<a href="#2-通道注意力机制版" class="hash-link" aria-label="Direct link to 2. 通道注意力机制版" title="Direct link to 2. 通道注意力机制版">​</a></h2>
<p>在生成器的残差块或特征融合模块中引入 Channel Attention 模块，同时引入 Squeeze-and-Excitation（SE）通道注意力模块，并在每个残差块之后插入 SEBlock(features)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class SEBlock(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, channel, reduction=16):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(SEBlock, self).__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.avg_pool = nn.AdaptiveAvgPool2d(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.fc1 = nn.Conv2d(channel, channel // reduction, 1, bias=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.relu = nn.ReLU(inplace=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.fc2 = nn.Conv2d(channel // reduction, channel, 1, bias=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.sigmoid = nn.Sigmoid()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Squeeze: Global Average Pooling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y = self.avg_pool(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Excitation: Fully connected layers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y = self.fc1(y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y = self.relu(y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y = self.fc2(y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y = self.sigmoid(y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return x * y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class SRResNetGenerator(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, in_channels=2, out_channels=2, features=64):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(SRResNetGenerator, self).__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.initial = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(in_channels, features, kernel_size=9, padding=4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PReLU()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 8 Residual Blocks with SE Blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        res_blocks = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for _ in range(8):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res_blocks.append(nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.Conv2d(features, features, kernel_size=3, padding=1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.BatchNorm2d(features),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.PReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.Conv2d(features, features, kernel_size=3, padding=1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.BatchNorm2d(features),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SEBlock(features)  # Add SE Block after each residual block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.res_blocks = nn.Sequential(*res_blocks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mid_conv = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features, kernel_size=3, padding=1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.upsample = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 4, 3, 1, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PixelShuffle(2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 4, 3, 1, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PixelShuffle(2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.final = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, out_channels, kernel_size=9, padding=4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Tanh()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1 = self.initial(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        res = x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for block in self.res_blocks:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = res + block(res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.mid_conv(res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = out + x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.upsample(out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.final(out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-多尺度特征融合版">3. 多尺度特征融合版<a href="#3-多尺度特征融合版" class="hash-link" aria-label="Direct link to 3. 多尺度特征融合版" title="Direct link to 3. 多尺度特征融合版">​</a></h2>
<p>网络结构中引入多尺度特征处理模块（如使用 3x3、5x5、7x7 不同卷积核或金字塔结构），并将不同尺度特征拼接或加权融合，最后添加至 SRResNetGenerator 内部结构中</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class MultiScaleFeatureFusion(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, in_channels, features):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(MultiScaleFeatureFusion, self).__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 使用膨胀卷积增加感受野</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.scale1 = nn.Conv2d(in_channels, features, kernel_size=3, padding=1, dilation=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.scale2 = nn.Conv2d(in_channels, features, kernel_size=5, padding=2, dilation=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.scale3 = nn.Conv2d(in_channels, features, kernel_size=7, padding=3, dilation=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.fusion = nn.Conv2d(features * 3, features, kernel_size=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1 = self.scale1(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x2 = self.scale2(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x3 = self.scale3(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fused = torch.cat([x1, x2, x3], dim=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.fusion(fused)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class SRResNetGenerator(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, in_channels=2, out_channels=2, features=64):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(SRResNetGenerator, self).__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.initial = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(in_channels, features, kernel_size=9, padding=4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PReLU()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Multi-scale feature fusion module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.multi_scale_fusion = MultiScaleFeatureFusion(in_channels=features, features=features)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 修改残差块，使用膨胀卷积</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        res_blocks = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for _ in range(8):  # 保持16个残差块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res_blocks.append(nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.Conv2d(features, features, kernel_size=3, padding=2, dilation=2),  # 使用膨胀卷积</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.BatchNorm2d(features),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.PReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.Conv2d(features, features, kernel_size=3, padding=2, dilation=2),  # 使用膨胀卷积</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nn.BatchNorm2d(features)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.res_blocks = nn.Sequential(*res_blocks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mid_conv = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features, kernel_size=3, padding=1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.BatchNorm2d(features)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.upsample = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 4, 3, 1, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PixelShuffle(2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, features * 4, 3, 1, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PixelShuffle(2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.PReLU(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.final = nn.Sequential(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Conv2d(features, out_channels, kernel_size=9, padding=4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.Tanh()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1 = self.initial(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Multi-scale feature fusion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x2 = self.multi_scale_fusion(x1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        res = x1 + x2  # Combine initial and multi-scale fused features</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for block in self.res_blocks:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = res + block(res)  # Residual learning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.mid_conv(res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = out + x1  # Add skip connection from initial input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out = self.upsample(out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.final(out)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-融合">4. 融合<a href="#4-融合" class="hash-link" aria-label="Direct link to 4. 融合" title="Direct link to 4. 融合">​</a></h2>
<p>同时采用：
· 感知 + MS-SSIM + MSE + GAN 损失；
· 多尺度结构；
· 通道注意力；</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-总结">5. 总结<a href="#5-总结" class="hash-link" aria-label="Direct link to 5. 总结" title="Direct link to 5. 总结">​</a></h2>
<table><thead><tr><th>实验名称</th><th>改进点类型</th><th>主要操作</th><th>作用</th></tr></thead><tbody><tr><td><strong>1. 损失函数改进</strong></td><td>损失函数层面</td><td>引入 <strong>多种损失组合</strong>，如感知损失（VGG）、MS-SSIM 等</td><td>更符合人类视觉感知，提升图像质量</td></tr><tr><td><strong>2. 通道注意力机制</strong></td><td>网络结构层面</td><td>在生成器中加入 <strong>通道注意力模块（如 SE/CA）</strong></td><td>自适应关注重要特征通道，提升表示能力</td></tr><tr><td><strong>3. 多尺度特征融合</strong></td><td>网络结构层面</td><td>引入多个尺度（不同尺寸卷积核或下采样路径  ）进行特征融合</td><td>更好保留图像纹理和细节</td></tr><tr><td><strong>4. 融合模型</strong></td><td>综合增强</td><td>同时引入注意力 + 多尺度 + 改进损失</td><td>协同提升性能，验证组合优势</td></tr></tbody></table></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/yourrepo/blog/12-Related GANs and their SRGAN ablation experiments.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/13-Deep Learning-Based Numerical Methods for High-Dimensional Parabolic Partial Differential Equations and Backward Stochastic Differential Equations"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Machine learning based spectral methods for partial differential equations</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/05-Automated and Context-Aware Repair of Color-Related Accessibility Issues for Android Apps"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Automated and Context-Aware Repair of Color-Related Accessibility Issues for Android Apps</div></a></nav><div style="margin-top:2rem"></div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-gangenerative-adversarial-network生成对抗网络" class="table-of-contents__link toc-highlight">1. GAN（Generative Adversarial Network）生成对抗网络</a></li><li><a href="#2-cganconditional-gan条件生成对抗网络" class="table-of-contents__link toc-highlight">2. cGAN（Conditional GAN）条件生成对抗网络</a></li><li><a href="#3-srgan" class="table-of-contents__link toc-highlight">3. SRGAN</a></li><li><a href="#4-esrgan" class="table-of-contents__link toc-highlight">4. ESRGAN</a></li><li><a href="#总结理论部分" class="table-of-contents__link toc-highlight">总结（理论部分）</a></li><li><a href="#1-cgan" class="table-of-contents__link toc-highlight">1. cGAN</a><ul><li><a href="#11-安装需要的包与环境" class="table-of-contents__link toc-highlight">1.1 安装需要的包与环境</a></li><li><a href="#12-数据预处理" class="table-of-contents__link toc-highlight">1.2 数据预处理</a></li><li><a href="#13-自定义数据集类" class="table-of-contents__link toc-highlight">1.3 自定义数据集类</a></li><li><a href="#14-定义生成器" class="table-of-contents__link toc-highlight">1.4 定义生成器</a></li><li><a href="#15-定义判别器" class="table-of-contents__link toc-highlight">1.5 定义判别器</a></li><li><a href="#16-计算指标" class="table-of-contents__link toc-highlight">1.6 计算指标</a></li><li><a href="#17-加载数据集准备训练" class="table-of-contents__link toc-highlight">1.7 加载数据集，准备训练</a></li><li><a href="#18-模型训练" class="table-of-contents__link toc-highlight">1.8 模型训练</a></li><li><a href="#19-模型验证" class="table-of-contents__link toc-highlight">1.9 模型验证</a></li><li><a href="#110-保存" class="table-of-contents__link toc-highlight">1.10 保存</a></li></ul></li><li><a href="#2-srgan" class="table-of-contents__link toc-highlight">2. SRGAN</a><ul><li><a href="#21-生成器模型-srresnetgenerator" class="table-of-contents__link toc-highlight">2.1 生成器模型 SRResNetGenerator</a></li><li><a href="#22-定义判别器-discriminator" class="table-of-contents__link toc-highlight">2.2 定义判别器 Discriminator</a></li></ul></li><li><a href="#3-esrgan" class="table-of-contents__link toc-highlight">3. ESRGAN</a><ul><li><a href="#31-生成器模型-rdbnet" class="table-of-contents__link toc-highlight">3.1 生成器模型 RDBNet</a></li><li><a href="#32-判别器模型-esrdiscriminator" class="table-of-contents__link toc-highlight">3.2 判别器模型 ESRDiscriminator</a></li></ul></li><li><a href="#1-损失函数改进版" class="table-of-contents__link toc-highlight">1. 损失函数改进版</a></li><li><a href="#2-通道注意力机制版" class="table-of-contents__link toc-highlight">2. 通道注意力机制版</a></li><li><a href="#3-多尺度特征融合版" class="table-of-contents__link toc-highlight">3. 多尺度特征融合版</a></li><li><a href="#4-融合" class="table-of-contents__link toc-highlight">4. 融合</a></li><li><a href="#5-总结" class="table-of-contents__link toc-highlight">5. 总结</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文档</h4></div><div class="col footer__col"><h4 class="footer__title">社区</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">更多</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/FEMATHS" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>