<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">CityLearn experiment | 机器学习小纵队</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-test-site.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-test-site.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/blog/26-CityLearn_experiment"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="CityLearn experiment | 机器学习小纵队"><meta data-rh="true" name="description" content="代码路径：https://github.com/zqqqqqqj1110/CityLearn_exp.git"><meta data-rh="true" property="og:description" content="代码路径：https://github.com/zqqqqqqj1110/CityLearn_exp.git"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-10-27T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/zqqqqqqj1110"><meta data-rh="true" property="article:tag" content="RL"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/blog/26-CityLearn_experiment"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/26-CityLearn_experiment" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/26-CityLearn_experiment" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="机器学习小纵队 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="机器学习小纵队 Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.228fc0ae.css">
<script src="/assets/js/runtime~main.446b8010.js" defer="defer"></script>
<script src="/assets/js/main.7b814f83.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="机器学习小纵队" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/favicon.ico" alt="机器学习小纵队" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">机器学习小纵队</b></a><a class="navbar__item navbar__link" href="/docs/ch0/FEMATHS-wiki-introduction">计算数学以及机器学习Wiki</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">FEMATHS小组学习日志</a><a class="navbar__item navbar__link" href="/members">FEMATHS小组成员</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/FEMATHS" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/23-CityLearn v1.0 An OpenAI Gym Environment for Demand Response with Deep Reinforcement Learning">CityLearn v1.0 - An OpenAI Gym Environment for Demand Response with Deep Reinforcement Learning</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/24-CityLearn v2">CityLearn v2: Energy-flexible, resilient, occupant-centric, and carbon-aware management of grid-interactive communities</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/25-AI classification">AI世界大入门</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/26-CityLearn_experiment">CityLearn experiment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/assets/25-AI classification">AI世界大入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/21-A Physics-Informed Neural Network (PINN) framework for generic bioreactor modelling">A Physics-Informed Neural Network (PINN) framework for generic bioreactor modelling</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/22-">A high order explicit time finite element method for the acoustic wave equation with discontinuous coefficients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/20-An efficient hp-Variational PINNs framework for incompressible  Navier-Stokes equations">An efficient hp-Variational PINNs framework for incompressible  Navier-Stokes equations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/19-Multidomain Legendre–Galerkin Chebyshev-collocation method for one-dimensional evolution equations with discontinuity">Multidomain Legendre–Galerkin Chebyshev-collocation method for one-dimensional evolution equations with discontinuity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/18-HomPINNs_Homotopy_physics-informed_neural_networks_for_learning_multiple_solutions_of_nonlinear_elliptic_differential_equations">HomPINNs: Homotopy physics-informed neural networks for learning multiple solutions of nonlinear elliptic differential equations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/17-An_efficient_neural-network_and_finite-difference_hybrid_method_for_elliptic_interface_problems_with_applications">An efficient neural-network and finite-difference hybrid  method for elliptic interface problems with applications</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/16-A_new_analytical_formula_for_the_wave_equations_with_variable_coefficients">A new analytical formula for the wave equations with variable coefficients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/15-Novel_and_general_discontinuity-removing_PINNs_for_elliptic_interface_problems">Novel and general discontinuity-removing PINNs for elliptic interface problems</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/14-DeepONet_Learning_nonlinear_operators_for_identifying">DeepONet: Learning nonlinear operators for identifying differential equations based on the universal approximation theorem of operators</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/13-Deep Learning-Based Numerical Methods for High-Dimensional Parabolic Partial Differential Equations and Backward Stochastic Differential Equations">Machine learning based spectral methods for partial differential equations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/12-Related GANs and their SRGAN ablation experiments">Related GANs and their SRGAN ablation experiments</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/05-Automated and Context-Aware Repair of Color-Related Accessibility Issues for Android Apps">Automated and Context-Aware Repair of Color-Related Accessibility Issues for Android Apps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/00-Ahead-of-our-research-efforts">欢迎来到FEMATHS小组学习日志</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/01-how-to-find-good-research-paper">从入门到入土？不，是精通！科技论文完全指南：如何找到一篇合适的科技论文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/02-how-to-read-research-paper">从入门到入土？不，是精通！科技论文完全指南：如何正确且高效地阅读一篇科技论文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/03-how-to-write-research-paper">从入门到入土？不，是精通！科技论文完全指南：如何写出一篇优秀的科技论文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/06-Bioinformatic analysis1（Linux Operation Guide）">Bioinformatic analysis:linux操作指南之上游分析(Part 1)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/07-Bioinformatic analysis2（Quality control and clustering）">Bioinformatic analysis:质量控制与聚类分析(Part 2)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/08-Bioinformatic analysis3（Differential genes and cell labeling）">Bioinformatic analysis:差异基因与细胞标注(Part3)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/09-Bioinformatic analysis4（Enrichment analysis）">Bioinformatic analysis:富集分析 (Part4)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/10-Bioinformatic analysis5（PPI and FT Analysis）">Bioinformatic analysis:PPI分析(Part 5)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/11-Bioinformatic analysis6（Sequential analysis）">Bioinformatic analysis:拟时序分析(Part 6)</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/04-Physics-Informed-Deep-Learning-Part-one">Physics Informed Deep Learning (Part I) Data-driven  Solutions of Nonlinear Partial Differential Equations</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">CityLearn experiment</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-10-27T00:00:00.000Z">October 27, 2025</time> · <!-- -->25 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/zqqqqqqj1110" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/95482898?v=4" alt="zqqqj"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/zqqqqqqj1110" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">zqqqj</span></a></div><small class="authorTitle_nd0D" title="super bug engineer 4 nlp,robot,cv,ml and ds">super bug engineer 4 nlp,robot,cv,ml and ds</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="代码路径httpsgithubcomzqqqqqqj1110citylearn_expgit">代码路径：<a href="https://github.com/zqqqqqqj1110/CityLearn_exp.git" target="_blank" rel="noopener noreferrer">https://github.com/zqqqqqqj1110/CityLearn_exp.git</a><a href="#代码路径httpsgithubcomzqqqqqqj1110citylearn_expgit" class="hash-link" aria-label="Direct link to 代码路径httpsgithubcomzqqqqqqj1110citylearn_expgit" title="Direct link to 代码路径httpsgithubcomzqqqqqqj1110citylearn_expgit">​</a></h2>
<h1>target</h1>
<p>比较不同任务配置下，RBC（Rule-Based Control）与 RLC（Reinforcement Learning Control）在能源、排放、峰值与舒适度方面的表现。
数量： 共 17 个任务（单建筑、多建筑、单目标、多目标）
输出指标：</p>
<ol>
<li>Electricity Cost [$]</li>
<li>Emissions [kg CO₂]</li>
<li>Peak Demand [kW]</li>
<li>Discomfort Penalty [–]</li>
</ol>
<h1>准备环境</h1>
<p>创建环境，准备 citylearn 的 conda env</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">conda create -n citylearn python=3.10 -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conda activate citylearn</span><br></span></code></pre></div></div>
<p>安装 city learn V2</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/intelligent-environments-lab/CityLearn.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd CityLearn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install -e .    # 源码控制版，仅用于复现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install citylearn   # 后续试验可以直接用这个下载</span><br></span></code></pre></div></div>
<p>如果是 macOS，pip install 的时候会发生如下报错：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ERROR: Ignored the following versions that require a different python version: 2.3.0 Requires-Python &gt;=3.11; 2.3.1 Requires-Python &gt;=3.11; 2.3.2 Requires-Python &gt;=3.11; 2.3.3 Requires-Python &gt;=3.11; 2.3.4 Requires-Python &gt;=3.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR: Could not find a version that satisfies the requirement openstudio&lt;=3.3.0 (from citylearn) (from versions: 3.5.0, 3.5.1, 3.6.0, 3.6.1, 3.7.0rc1, 3.7.0, 3.8.0, 3.9.0, 3.10.0rc5, 3.10.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR: No matching distribution found for openstudio&lt;=3.3.0</span><br></span></code></pre></div></div>
<p>这是因为 OpenStudio 只支持 x86 架构，Apple Silicon (arm64) 下没有编译版本，跳过依赖，自己手动安装</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip install -e . --no-deps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install numpy==1.26.4 pandas pyyaml scikit-learn==1.2.2 simplejson torch torchvision gymnasium==0.28.1 nrel-pysam doe_xstock</span><br></span></code></pre></div></div>
<p>这边建议还是用 linux 比较好，后续复现都基于 Linux 而非 macOS，macOS 的环境配置等我有空了再写（毕竟本地运行最方便）</p>
<p>目前 macOS 失败的原因：<strong>OpenStudio 不支持 macOS ARM 架构</strong></p>
<h1>进行测试</h1>
<p>配置完环境之后，可以使用测试代码看看效果</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.citylearn import CityLearnEnv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from pathlib import Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 加载 CityLearn 环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema = Path(&#x27;/root/CityLearn/data/datasets/citylearn_challenge_2021/schema.json&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env = CityLearnEnv(schema=schema)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(&quot;✅ Env loaded successfully!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重置环境（Gymnasium 风格）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obs, info = env.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 打印建筑数量与ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(&quot;✅ Number of buildings:&quot;, len(env.buildings))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 打印每栋建筑的观测长度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obs_lens = [len(o) for o in obs]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(&quot;✅ Observation lengths per building:&quot;, obs_lens)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例：查看第一个建筑的前5个特征</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(&quot;✅ Sample observation (Building 1):&quot;, obs[0][:5])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果要转换为矩阵，可以先对齐长度（取最短长度或补零）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">min_len = min(obs_lens)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obs_array = np.array([o[:min_len] for o in obs])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(&quot;✅ Converted obs array shape:&quot;, obs_array.shape)</span><br></span></code></pre></div></div>
<p>有五个 ✅ 就 ok 了，输出结果应该如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(citylearnv2) root@autodl-container-491e4b9a34-9e5b11d5:~/CityLearn# python Untitled1.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Couldn&#x27;t import dot_parser, loading of dot files will not be possible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Env loaded successfully!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Number of buildings: 9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Observation lengths per building: [28, 27, 26, 27, 28, 28, 27, 27, 27]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Sample observation (Building 1): [1, 4, 1, 9.4, 10.020000457763672]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Converted obs array shape: (9, 26)</span><br></span></code></pre></div></div>
<p>number of buildings 可以理解为 agent 的数量，每一个 agent 都是一个独立的智能体，共享天气、电价、碳排放等全局信息，共同学习协调策略
Observation lengths per building 是每个 agent 的特征数量，这些特征可以是
当前电价，CO₂ 强度，当前时刻，设备能耗（DHW、TES、Battery） 等
Sample observation 把一栋建筑的特征编码成一个一维数组，具体含义取决于 schema 的配置（observations 字段），如下所示：
<img decoding="async" loading="lazy" src="http://8.130.141.48/wp-content/uploads/2025/11/17616169599159-scaled.jpg" alt="" class="img_ev3q">
Converted obs array shape 是传入到模型的数组，是一个大整体，用于训练</p>
<h1>Control task distribution</h1>
<p>该章节设计了 17 个不同的控制任务，对比 3 种控制方式 + 4 种控制目标。三种方法在代码中的本质区别就是 reward 不同，需要在传入 CityLearnEnv() 时，自定义 Reward Function</p>
<table><thead><tr><th>控制器</th><th>简介</th><th>类型</th></tr></thead><tbody><tr><td><strong>Baseline</strong></td><td>无控制，直接跟随负荷曲线</td><td>被动</td></tr><tr><td><strong>RBC (rule-based controller)</strong></td><td>手工设定规则 ，例如“电价低时充电”</td><td>基准控制</td></tr><tr><td><strong>RLC (reinforcement learning controller)</strong></td><td>SAC 算法自动学习策略</td><td>强化学习</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-cost-or-emission-reduction">1. Cost or Emission Reduction<a href="#1-cost-or-emission-reduction" class="hash-link" aria-label="Direct link to 1. Cost or Emission Reduction" title="Direct link to 1. Cost or Emission Reduction">​</a></h2>
<p>以最小化电费成本或碳排放总量为 KPI，进行三种方式的训练</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-实验设置">1.1 实验设置<a href="#11-实验设置" class="hash-link" aria-label="Direct link to 1.1 实验设置" title="Direct link to 1.1 实验设置">​</a></h3>
<p>数据集： CityLearn Challenge 2023 (Phase 2 local evaluation)
建筑： 9 栋住宅
控制对象： DHW (热水储能) 或 BESS + PV (电池储能+光伏)
控制变量： 储能充放电功率</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-环境">1.2 环境<a href="#12-环境" class="hash-link" aria-label="Direct link to 1.2 环境" title="Direct link to 1.2 环境">​</a></h3>
<p>Baseline – 不做任何控制。
RBC – 手动规则：
电价低 → 充能；
电价高 → 放能。
SAC – 深度强化学习自动学习最优调度</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-代码">1.3 代码<a href="#13-代码" class="hash-link" aria-label="Direct link to 1.3 代码" title="Direct link to 1.3 代码">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.citylearn import CityLearnEnv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.base import BaselineAgent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.rbc import BasicRBC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.sac import SAC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from pathlib import Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def run(agent_class, schema, episodes=1, central_agent=True, save_dir=None, **kwargs):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;\n=== Running {agent_class.__name__} ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env = CityLearnEnv(schema, central_agent=central_agent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent = agent_class(env)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent.learn(episodes=episodes, deterministic_finish=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    results = env.evaluate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;✅ {agent_class.__name__} finished.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if save_dir:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Path(save_dir).mkdir(parents=True, exist_ok=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (Path(save_dir)/&quot;metrics.txt&quot;).write_text(str(results))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def main():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 使用本地数据集 schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema = &quot;data/datasets/citylearn_challenge_2023_phase_2_local_evaluation/schema.json&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 1 Baseline 无控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res_base = run(BaselineAgent, schema, episodes=1, central_agent=True, save_dir=&quot;results/4_1_1_baseline&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 2 RBC 规则控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res_rbc = run(BasicRBC, schema, episodes=1, central_agent=True, save_dir=&quot;results/4_1_1_rbc&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 3 SAC 强化学习控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res_sac = run(SAC, schema, episodes=5, central_agent=False, save_dir=&quot;results/4_1_1_sac&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 输出对比结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;\n=== Comparison ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;Baseline:&quot;, res_base)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;RBC:&quot;, res_rbc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;SAC:&quot;, res_sac)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main()</span><br></span></code></pre></div></div>
<p>目的是在相同环境下，依次运行三种控制策略（Baseline → RBC → SAC），并保存结果。主体是 run 函数，就详细讲他了
run 函数是一个通用的实验运行函数，分为一下步骤</p>
<ol>
<li>初始化环境</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">env = CityLearnEnv(schema, central_agent=central_agent)</span><br></span></code></pre></div></div>
<p>CityLearnEnv 是 CityLearn 的核心环境类，它根据 schema.json 读取城市能耗数据（建筑负荷、电价、太阳能、天气等）。
参数：
schema: 定义数据来源与环境配置（相当于一个配置文件路径）
central_agent: 是否为集中式控制（True 表示一个智能体控制所有建筑）</p>
<ol start="2">
<li>初始化智能体</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">agent = agent_class(env)</span><br></span></code></pre></div></div>
<p>BaselineAgent：完全不做控制（仅被动执行环境动作）
BasicRBC：基于规则的控制（Rule-Based Control）
SAC：强化学习算法 Soft Actor-Critic 控制器</p>
<ol start="3">
<li>训练智能体</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">agent.learn(episodes=episodes, deterministic_finish=True)</span><br></span></code></pre></div></div>
<p>episodes：训练轮数（你给 Baseline/RBC 各 1 次，SAC 给 5 次）
deterministic_finish=True：在最后一个 episode 以确定性方式结束（用于评估)</p>
<ol start="4">
<li>评估结果</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">results = env.evaluate()</span><br></span></code></pre></div></div>
<p>返回一个性能指标字典，如能耗、峰值负荷、碳排放、成本等</p>
<ol start="5">
<li>打印与保存</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="14-问题汇总">1.4 问题汇总<a href="#14-问题汇总" class="hash-link" aria-label="Direct link to 1.4 问题汇总" title="Direct link to 1.4 问题汇总">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="141-rbc规则控制的规则是什么代码中怎么体现">1.4.1 RBC（规则控制）的规则是什么？代码中怎么体现？<a href="#141-rbc规则控制的规则是什么代码中怎么体现" class="hash-link" aria-label="Direct link to 1.4.1 RBC（规则控制）的规则是什么？代码中怎么体现？" title="Direct link to 1.4.1 RBC（规则控制）的规则是什么？代码中怎么体现？">​</a></h4>
<p>RBC（Rule-Based Control）是 基于人工经验规则的控制策略。在 CityLearn 中，RBC 主要负责控制每栋建筑的储能设备（电池）何时充电、何时放电。
默认规则如下：
当电价低（off-peak）时 → 充电
当电价高（peak）时 → 放电
若电池满或空 → 不动作
逻辑定义在 city learn 包的该文件中：citylearn/agents/rbc.py。简单的来说，就是一个 if else 而已</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="142-sac强化学习控制用的是什么算法">1.4.2. SAC（强化学习控制）用的是什么算法？<a href="#142-sac强化学习控制用的是什么算法" class="hash-link" aria-label="Direct link to 1.4.2. SAC（强化学习控制）用的是什么算法？" title="Direct link to 1.4.2. SAC（强化学习控制）用的是什么算法？">​</a></h4>
<p>SAC 是 Soft Actor-Critic）算法，基于最大熵强化学习（Maximum Entropy RL）的连续动作控制算法。就跟流程图中的一样，有三部分构成</p>
<table><thead><tr><th>模块</th><th>类型</th><th>功能</th></tr></thead><tbody><tr><td>Actor</td><td>策略网络</td><td>生成动作分布</td></tr><tr><td>Critic₁ / Critic₂</td><td>Q 网络</td><td>评估动作价值</td></tr><tr><td>Target Critic</td><td>目标网络</td><td>稳定训练</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="143-rbc-规则能否自定义">1.4.3. RBC 规则能否自定义<a href="#143-rbc-规则能否自定义" class="hash-link" aria-label="Direct link to 1.4.3. RBC 规则能否自定义" title="Direct link to 1.4.3. RBC 规则能否自定义">​</a></h4>
<p>BasicRBC 是 CityLearn 自带的默认规则控制器（定义在 rbc.py）。但完全可以自定义自己的规则。只需继承基类并重写 select_actions()即可
例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.base import BaseAgent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyRBC(BaseAgent):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def select_actions(self, observations):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actions = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for obs in observations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            price = obs[&#x27;electricity_price&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            soc = obs[&#x27;storage_soc&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            solar = obs[&#x27;solar_generation&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if price &lt; 0.05 and solar &gt; 0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                action = 1.0      # 加强充电</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif price &gt; 0.2 or soc &gt; 0.8:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                action = -1.0     # 放电</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                action = 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            actions.append(action)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return actions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run(MyRBC, schema, episodes=1, central_agent=True)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="144-sac-强化学习控制是否和问题-3-一样">1.4.4. SAC 强化学习控制是否和问题 3 一样？<a href="#144-sac-强化学习控制是否和问题-3-一样" class="hash-link" aria-label="Direct link to 1.4.4. SAC 强化学习控制是否和问题 3 一样？" title="Direct link to 1.4.4. SAC 强化学习控制是否和问题 3 一样？">​</a></h4>
<p>也可以和问题 3 一样，自定义，只要实现相同接口即可
例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.base import BaseAgent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from stable_baselines3 import PPO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class PPOAgent(BaseAgent):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, env):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(env)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model = PPO(&#x27;MlpPolicy&#x27;, env, verbose=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def learn(self, episodes=1, **kwargs):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model.learn(total_timesteps=episodes * len(self.env.time_steps))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def select_actions(self, observations):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action, _ = self.model.predict(observations, deterministic=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run(PPOAgent, schema, episodes=5, central_agent=False)</span><br></span></code></pre></div></div>
<p>ps：schema 文件中 reward_function 配置（具体在 2.2 中解释）</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;reward_function&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;type&quot;: &quot;citylearn.reward_function.RewardFunction&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;attributes&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;electricity_cost_weight&quot;: 0.6,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;emission_weight&quot;: 0.4,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;peak_to_average_ratio_weight&quot;: 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-peak-reduction">2. Peak Reduction<a href="#2-peak-reduction" class="hash-link" aria-label="Direct link to 2. Peak Reduction" title="Direct link to 2. Peak Reduction">​</a></h2>
<p>以削减社区总功率峰值为 KPI，进行三种方式的训练</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-环境">2.1 环境<a href="#21-环境" class="hash-link" aria-label="Direct link to 2.1 环境" title="Direct link to 2.1 环境">​</a></h3>
<p>RBC 仍按规则上述运行
SAC 自动学会错峰操作——让各建筑在不同时间放电。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-代码">2.2 代码<a href="#22-代码" class="hash-link" aria-label="Direct link to 2.2 代码" title="Direct link to 2.2 代码">​</a></h3>
<p>4.1.2 节中明确指出，实验目标变为降低峰值负荷（district-level daily peak load）。文中说明：
“Configurations with peak reduction objective… The RBC has been fine-tuned to target energy discharge during peak periods…”</p>
<p>而在 CityLearn 环境中，KPI 由 reward_function 控制。所以要把 4.1.1 的“cost / emission minimization” 改成 4.1.2 的“peak reduction”，只需在 schema.json 里修改 reward 配置即可。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;reward_function&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;type&quot;: &quot;citylearn.reward_function.RewardFunction&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;attributes&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;electricity_cost_weight&quot;: 0.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;emission_weight&quot;: 0.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;peak_to_average_ratio_weight&quot;: 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>其他代码与 4.1.1 相同</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-discomfort-and-electricity-consumption-reduction">3. Discomfort and Electricity Consumption Reduction<a href="#3-discomfort-and-electricity-consumption-reduction" class="hash-link" aria-label="Direct link to 3. Discomfort and Electricity Consumption Reduction" title="Direct link to 3. Discomfort and Electricity Consumption Reduction">​</a></h2>
<p>KPI 为在节能的同时维持舒适度（供暖、热水温度等）</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-代码">3.1 代码<a href="#31-代码" class="hash-link" aria-label="Direct link to 3.1 代码" title="Direct link to 3.1 代码">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;reward_function&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;type&quot;: &quot;citylearn.reward_function.ComfortReward&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;attributes&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;band&quot;: 1.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;lower_exponent&quot;: 2.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;higher_exponent&quot;: 3.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;m&quot;: 3.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;mode&quot;: &quot;cooling&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">summary<a href="#summary" class="hash-link" aria-label="Direct link to summary" title="Direct link to summary">​</a></h2>
<p>在 4.1 部分的实验中，通过修改 schema.json 中的 reward_function 配置即可切换不同的性能评价指标（KPI）与控制目标，从而实现基于不同优化目标的策略训练</p>
<table><thead><tr><th>类名</th><th>所属模块</th><th>简要说明</th><th>可配参数（kwargs/attributes）示例</th></tr></thead><tbody><tr><td><code>RewardFunction</code></td><td><code>citylearn.reward_function</code></td><td>默认通用奖励函数，惩罚从网格购买电力。 ([citylearn.net][1])</td><td><code>exponent</code>（如 1.0）、<code>charging_constraint_penalty_coefficient</code> 等</td></tr><tr><td><code>MARL</code></td><td><code>citylearn.reward_function</code></td><td>用于多体（multi-agent）场景的奖励函数</td><td>无或少量额外参数</td></tr><tr><td><code>IndependentSACReward</code></td><td><code>citylearn.reward_function</code></td><td>推荐用于每建筑独立 agent 的 SAC 控制器奖励。</td><td>无或少量参数</td></tr><tr><td><code>SolarPenaltyReward</code></td><td><code>citylearn.reward_function</code></td><td>鼓励净零／最大化自发电、减少从电网购电。</td><td>默认行为，无需额外参数或可配置参数如系数</td></tr><tr><td><code>ComfortReward</code></td><td><code>citylearn.reward_function</code></td><td>以室内温度偏差（舒适度）为目标的奖励函数。</td><td><code>band</code>（舒适带宽）、<code>lower_exponent</code>、<code>higher_exponent</code> 等</td></tr><tr><td><code>SolarPenaltyAndComfortReward</code></td><td><code>citylearn.reward_function</code></td><td>结合太阳能惩罚 + 舒适度惩罚的混合型奖励。</td><td><code>band</code>、<code>lower_exponent</code>、<code>higher_exponent</code>、<code>coefficients</code> 等</td></tr></tbody></table>
<p>所有的 reward_function 可以在这看：<a href="https://www.citylearn.net/api/citylearn.reward_function.html?utm_source=chatgpt.com" target="_blank" rel="noopener noreferrer">https://www.citylearn.net/api/citylearn.reward_function.html?utm_source=chatgpt.com</a></p>
<p>当然，以上仅针对 SAC，如果是 RBC，需要修改 rbc.py 文件里的策略，不过我觉得重点是 SAC，所以暂且就先不管 RBC 的规则修改了</p>
<h1>Energy storage system control in representative single-family neighborhoods</h1>
<p>如果说 4.1 是多目标基准测试（环境固定，控制算法固定，KPI 不同），那 4.2 就是<strong>不同建筑类型（如单层房、多层房、带太阳能的房屋）具有不同负荷特性与储能需求，同样的控制算法在这些“代表性住宅”上会表现出不同的能耗动态。</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-重点">1. 重点<a href="#1-重点" class="hash-link" aria-label="Direct link to 1. 重点" title="Direct link to 1. 重点">​</a></h2>
<ol>
<li>采用相同的 RL 控制策略（通常是 SAC）；</li>
<li>在不同的 “representative neighborhoods” schema 上运行；</li>
<li>比较结果
· 电池充放电曲线 (SOC)
· 负荷曲线平滑程度
· 成本或碳排结果差 异</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-区别">2. 区别<a href="#2-区别" class="hash-link" aria-label="Direct link to 2. 区别" title="Direct link to 2. 区别">​</a></h2>
<table><thead><tr><th>项目</th><th>4.1 部分</th><th>4.2 部分</th></tr></thead><tbody><tr><td><strong>实验主题</strong></td><td>Benchmark 实验：在统一城市社区下测试不同 KPI（成本、碳排、峰值、舒适度）</td><td>应用实验：测试控制算法在<strong>代表性住宅社区</strong>的真实储能控制性能</td></tr><tr><td><strong>实验目标（KPI）</strong></td><td>切换不同 reward_function，比较不同优化目标</td><td>固定 reward（通常是 cost/emission），考察算法在不同建筑类型下的行为差异</td></tr><tr><td><strong>控制结构</strong></td><td>集中式或半集中式控制（central_agent 可 True）</td><td><strong>分布式控制</strong>（central_agent=False，每栋建筑独立 agent）</td></tr><tr><td><strong>环境规模</strong></td><td>通常是完整城市或区域（多个住宅+商用建筑）</td><td>缩小到单家庭或少量代表性住宅群</td></tr><tr><td><strong>重点分析</strong></td><td>“不同 KPI 下的优化目标”</td><td>“储能系统在现实住宅场景中的动态控制表现”</td></tr><tr><td><strong>输出指标</strong></td><td>reward 曲线、总能耗、PAR</td><td>每户建筑的电池 SOC 曲线、功率负荷、峰值变化趋势</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-代码">3. 代码<a href="#3-代码" class="hash-link" aria-label="Direct link to 3. 代码" title="Direct link to 3. 代码">​</a></h2>
<p>和 4.1 其实大同小异，central_agent=False 即可，突出各 agent 单独训练</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ============================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># CityLearn 4.2 实验复现: Energy storage system control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 参考论文 Section 4.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ============================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.citylearn import CityLearnEnv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.base import BaselineAgent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.rbc import BasicRBC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.sac import SAC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from pathlib import Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from debug_sac import DebugSAC  # ✅ 使用调试版本，不改库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 测试用，仅使用n栋buildings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def run(agent_class, schema, episodes=1, central_agent=False, save_dir=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;\n=== Running {agent_class.__name__} | Central Agent = {central_agent} ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ✅ 正确选择前三栋建筑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env_full = CityLearnEnv(schema, central_agent=central_agent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selected_buildings = env_full.buildings[:20]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env_full.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ✅ 用3栋建筑创建新环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env = CityLearnEnv(schema, buildings=selected_buildings, central_agent=central_agent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent = agent_class(env)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent.learn(episodes=episodes, deterministic_finish=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    results = env.evaluate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;✅ {agent_class.__name__} finished.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;📊 Results: {results}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if save_dir:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Path(save_dir).mkdir(parents=True, exist_ok=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (Path(save_dir) / &quot;metrics.txt&quot;).write_text(str(results))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># def run(agent_class, schema, episodes=1, central_agent=False, save_dir=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     print(f&quot;\n=== Running {agent_class.__name__} | Central Agent = {central_agent} ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     # ✅ 创建环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     env = CityLearnEnv(schema, buildings=env.buildings[:3], central_agent=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     # env = CityLearnEnv(schema, central_agent=central_agent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     env.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     # ✅ 创建 Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     agent = agent_class(env)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     # ✅ 训练 Agent（Baseline / RBC 会自动跳过 learn）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     agent.learn(episodes=episodes, deterministic_finish=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     # ✅ 评估指标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     results = env.evaluate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     env.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     print(f&quot;✅ {agent_class.__name__} finished.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     print(f&quot;📊 Results: {results}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     # ✅ 保存结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     if save_dir:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         Path(save_dir).mkdir(parents=True, exist_ok=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         (Path(save_dir) / &quot;metrics.txt&quot;).write_text(str(results))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     return results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def main():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema = &quot;data/datasets/ca_alameda_county_neighborhood/schema.json&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    central_agent = False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Baseline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        agent_class=BaselineAgent,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        schema=schema,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        episodes=1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        central_agent=central_agent,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        save_dir=&quot;results/4_2_baseline_CA&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # RBC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        agent_class=BasicRBC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        schema=schema,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        episodes=1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        central_agent=central_agent,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        save_dir=&quot;results/4_2_rbc_CA&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # SAC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        agent_class=DebugSAC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        schema=schema,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        episodes=5,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        central_agent=central_agent,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        save_dir=&quot;results/4_2_sac_CA&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-报错">4. 报错<a href="#4-报错" class="hash-link" aria-label="Direct link to 4. 报错" title="Direct link to 4. 报错">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-assertionerror">4.1 AssertionError<a href="#41-assertionerror" class="hash-link" aria-label="Direct link to 4.1 AssertionError" title="Direct link to 4.1 AssertionError">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AssertionError: demand is greater than heating_device max output | timestep: 0, building: resstock-amy2018-2021-release-1-122940, outage: False, demand: 3.1614, output: 2.9663, difference: 0.1950</span><br></span></code></pre></div></div>
<p>CityLearn 在 building.py 里写了安全检查,类型如下</p>
<table><thead><tr><th>原因类型</th><th>说明</th><th>是否致命</th></tr></thead><tbody><tr><td><strong>1️⃣ 数据异常</strong></td><td>某个住宅在输入数据（温度 / 负荷）首小时数值异常，使 heating_demand 超出设备额定功率</td><td>❌ 可跳过</td></tr><tr><td><strong>2️⃣ 模型初始化误差</strong></td><td>在 simulation_start_time_step=0 时，系统状态还没初始化完全，出现轻微不一致</td><td>❌ 可忽略</td></tr><tr><td><strong>3️⃣ 温控模型精度问题</strong></td><td>HVAC 模型在某些时刻计算的 heat_demand 与设备参数有微小误差</td><td>❌ 可通过容差参数放宽</td></tr></tbody></table>
<p>可以打开 citylearn/building.py
查找并修改：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># before</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assert self.power_outage or demand &lt;= max_device_output or abs(demand - max_device_output) &lt; TOLERANCE, \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f&quot;demand is greater than heating_device max output | ...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if not (self.power_outage or demand &lt;= max_device_output or abs(demand - max_device_output) &lt; TOLERANCE):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;[Warning] demand &gt; heating_device max output at timestep {self.time_step}&quot;)</span><br></span></code></pre></div></div>
<p>或者跑代码的时候直接 python -O run_4_2.py（忽略所有 assert 语句）</p>
<p>或者把容忍度从 1e-4 改大一些也行</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TOLERANCE = 1e-4</span><br></span></code></pre></div></div>
<p>但是总体而言问题不大，论文里说了，在基于 ResStock 的建筑数据中，由于缩放差异，初始化时可能会出现轻微的设备容量超限，这不会影响实验结果。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-typeerror-new-data-must-be-a-sequence-got-nonetype">4.2 TypeError: new(): data must be a sequence (got NoneType)<a href="#42-typeerror-new-data-must-be-a-sequence-got-nonetype" class="hash-link" aria-label="Direct link to 4.2 TypeError: new(): data must be a sequence (got NoneType)" title="Direct link to 4.2 TypeError: new(): data must be a sequence (got NoneType)">​</a></h3>
<p>先看报错内容</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(citylearnv2) root@autodl-container-491e4b9a34-9e5b11d5:~/CityLearn# python -O run_4_2.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Couldn&#x27;t import dot_parser, loading of dot files will not be possible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=== Running SAC ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Traceback (most recent call last):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  File &quot;/root/CityLearn/run_4_2.py&quot;, line 44, in &lt;module&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  File &quot;/root/CityLearn/run_4_2.py&quot;, line 40, in main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run(SAC, schema, episodes=5, central_agent=central_agent,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  File &quot;/root/CityLearn/run_4_2.py&quot;, line 16, in run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent.learn(episodes=episodes, deterministic_finish=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  File &quot;/root/CityLearn/citylearn/agents/base.py&quot;, line 156, in learn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actions = self.predict(observations, deterministic=deterministic)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  File &quot;/root/CityLearn/citylearn/agents/sac.py&quot;, line 189, in predict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actions = self.get_post_exploration_prediction(observations, deterministic)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  File &quot;/root/CityLearn/citylearn/agents/sac.py&quot;, line 206, in get_post_exploration_prediction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o = torch.FloatTensor(o).unsqueeze(0).to(self.device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TypeError: new(): data must be a sequence (got NoneType)</span><br></span></code></pre></div></div>
<p>常见成因如下</p>
<ol>
<li>
<p>初始化观测没准备好
部分版本/数据（尤其 LSTM/ResStock 建筑）在创建后第一拍的观测可能为空：
· 没 reset()
· 或 reset() 返回完第一帧仍需要一个“热身 step”才有有效 obs</p>
</li>
<li>
<p>schema 的观测被关了
如果 root.observations 里全都 &quot;active&quot;: false，或某些建筑在 buildings.*.inactive_observations 里把所有可观测量都禁用了，该建筑（甚至全局）观测会变成 None/空。</p>
</li>
<li>
<p>观测形态不匹配
central_agent=True → 期望得到“一个联合向量”；
central_agent=False → 期望“每栋一个向量的列表”。
如果有建筑 include: false / 观测被裁，列表里就会混入 None。</p>
</li>
</ol>
<p><strong>PS：太他妈变态了这个问题，这个 error 卡了我将近一周才知道哪里出现了问题</strong></p>
<p>解决方法（过于变态，我选择讲我怎么解决的）</p>
<ol>
<li>从数据集入手
可以运行一下这个代码，先查看 building 和 obs 里有没有 none</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># inspect_schema.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import json, sys, argparse, os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from typing import Any, Dict, List</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def load_schema(path: str) -&gt; Dict[str, Any]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    txt = open(path, &#x27;r&#x27;, encoding=&#x27;utf-8&#x27;).read()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 先尝试 JSON</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data = json.loads(txt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 可选：YAML（若安装了 PyYAML）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            import yaml  # pip install pyyaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            data = yaml.safe_load(txt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(f&quot;❌ 既不是 JSON 也不是可解析的 YAML：{e}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sys.exit(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 大多数 CityLearn schema 顶层有个 &#x27;root&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return data.get(&#x27;root&#x27;, data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def main():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ap = argparse.ArgumentParser()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ap.add_argument(&#x27;--schema&#x27;, required=True, help=&#x27;path/to/schema.json&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args = ap.parse_args()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sc = load_schema(args.schema)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;\n=== Top-level keys ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(list(sc.keys()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 1) central_agent &amp; sim period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;\n=== Simulation/Agent ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;central_agent:&quot;, sc.get(&#x27;central_agent&#x27;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;simulation_start_time_step:&quot;, sc.get(&#x27;simulation_start_time_step&#x27;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;simulation_end_time_step:&quot;, sc.get(&#x27;simulation_end_time_step&#x27;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;seconds_per_time_step:&quot;, sc.get(&#x27;seconds_per_time_step&#x27;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 2) observations（全局）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obs = sc.get(&#x27;observations&#x27;, {})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;\n=== Global Observations ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if not obs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;⚠️  observations 是空的（这会导致 SAC 观测为 None）&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actives = [k for k,v in obs.items() if isinstance(v, dict) and v.get(&#x27;active&#x27;, False)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inactives = [k for k,v in obs.items() if isinstance(v, dict) and not v.get(&#x27;active&#x27;, False)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;active 数量:&quot;, len(actives))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;active 列表(前20):&quot;, actives[:20])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if inactives:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(&quot;inactive 列表(前20):&quot;, inactives[:20])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 3) buildings（字典或列表）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b = sc.get(&#x27;buildings&#x27;, {})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;\n=== Buildings ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if isinstance(b, dict):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b_names = list(b.keys())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;建筑数量:&quot;, len(b_names))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sample = b_names[:5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;示例建筑:&quot;, sample)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检查 include / inactive_observations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        problem_buildings: List[str] = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fully_inactive: List[str] = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for name in b_names:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cfg = b[name] or {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            include = cfg.get(&#x27;include&#x27;, True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if not include:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                problem_buildings.append(name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inact = cfg.get(&#x27;inactive_observations&#x27;, [])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 如果把全局 active 都屏蔽了，也会导致该建筑 obs=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                actives = [k for k,v in obs.items() if isinstance(v, dict) and v.get(&#x27;active&#x27;, False)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if actives and isinstance(inact, list) and set(inact) &gt;= set(actives):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    fully_inactive.append(name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            except Exception:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if problem_buildings:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(f&quot;⚠️  有 {len(problem_buildings)} 栋建筑 include=false（可能导致 None）：&quot;, problem_buildings[:5])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if fully_inactive:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(f&quot;⚠️  有 {len(fully_inactive)} 栋建筑把所有全局观测都屏蔽了：&quot;, fully_inactive[:5])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;⚠️  buildings 不是字典（请贴内容我再看）&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 4) 快速“环境探针”（不训练，只 reset 看看 obs 形态）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from citylearn.citylearn import CityLearnEnv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ca = sc.get(&#x27;central_agent&#x27;, False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;\n=== Env probe (reset) ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env = CityLearnEnv(args.schema, central_agent=ca)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obs0 = env.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;reset() 返回类型:&quot;, type(obs0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if obs0 is None:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(&quot;❌ reset() 返回 None —— SAC 会在 FloatTensor(None) 处报错。&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # centralized → 向量/数组；decentralized → list[数组]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if isinstance(obs0, list):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    shapes = [getattr(x, &#x27;shape&#x27;, None) for x in obs0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    print(&quot;分布式观测数量:&quot;, len(obs0), &quot;示例形状:&quot;, shapes[:5])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    print(&quot;集中式观测形状:&quot;, getattr(obs0, &#x27;shape&#x27;, None))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            except Exception:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;（可选探针失败：）&quot;, e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &#x27;__main__&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main()</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" src="http://8.130.141.48/wp-content/uploads/2025/11/17622520053493-scaled.jpg" alt="" class="img_ev3q">
我的运行结果</p>
<ol>
<li>进行调试
从报错中可以知道，问题主要是出现在 sac.py 的 self.get_post_exploration_prediction 里，再建一个 py 文件重写该类，查看到底是哪一步出现了问题</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.sac import SAC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DebugSAC(SAC):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;&quot;&quot;调试用 SAC：不改原库，但打印 observation &amp; None 来源&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_post_exploration_prediction(self, observations, deterministic=False):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # ✅ 如果是 dict，先转换为 list，避免原始错误</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if isinstance(observations, dict):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            observations = [obs for obs in observations.values()]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actions = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i, o in enumerate(observations):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # ✅ Debug：打印原始 obs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(f&quot;\n🔍 [Debug] Building {i} raw obs = {o}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if o is None:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                raise ValueError(f&quot;❌ Observation from agent {i} is None (raw environment output)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # ✅ 编码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            encoded = self.get_encoded_observations(i, o)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(f&quot;   ➤ Encoded obs = {encoded}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if encoded is None:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                raise ValueError(f&quot;❌ get_encoded_observations() returned None for agent {i}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # ✅ 归一化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            normalized = self.get_normalized_observations(i, encoded)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(f&quot;   ➤ Normalized obs = {normalized}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if normalized is None:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                raise ValueError(f&quot;❌ get_normalized_observations() returned None for agent {i}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # ✅ 尝试转成 tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                o_tensor = torch.FloatTensor(normalized).unsqueeze(0).to(self.device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                print(f&quot;❌ Failed to convert obs to tensor. Obs = {normalized}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                raise e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # ✅ 原来的 action 获取流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = self.policy_net[i].sample(o_tensor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            a = result[2] if deterministic else result[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            actions.append(a.detach().cpu().numpy()[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return actions</span><br></span></code></pre></div></div>
<p>把步骤分 开，终于！找到了问题所在--normalized，为什么会有这个问题呢？
<strong>reason：</strong>
CityLearn SAC 中归一化机制没有被初始化 / 未启用或遇到了无效值，所以 get_normalized_observations() 返回了 None → 传给 torch.FloatTensor() → 报错
这是 CityLearn SAC 框架的一个“设计缺陷”（默认不开启 normalization，又没有 fallback 机制）
citylearn 的默认流程是这样的：</p>
<ol>
<li>normalization_enable 默认是 True</li>
<li>但 normalization 参数（mean/std）只会在训练若干步后才更新</li>
<li>第 1 个 timestep 直接调用 predict() → normalization 矩阵还没有 → 返回 None</li>
</ol>
<p><strong>soluation</strong>
归一化在 SAC 中还是需要的，不然会难以收敛或不稳定，而且不能修改 schema 里的数据（json 里保存的都是真实原始数据）
两种方法</p>
<ol>
<li>在训练前自动收集数据，初始化 mean/std</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 初始化 normalization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obs_buffer = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obs = env.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for _ in range(500):  # 收集前 500 步</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    action = env.action_space.sample()   # 随机动作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obs, _, _, _ = env.step(action)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obs_list = list(obs.values()) if isinstance(obs, dict) else obs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obs_buffer.extend(obs_list)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obs_buffer = np.array(obs_buffer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">agent.obs_mean = np.mean(obs_buffer, axis=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">agent.obs_std = np.std(obs_buffer, axis=0) + 1e-6  # 避免除0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(&quot;✅ Normalization initialized.&quot;)</span><br></span></code></pre></div></div>
<ol start="2">
<li>中途动态归一化
在 SAC 内部每收集一批数据就更新 mean/std（类似 running mean）,只需训练前手动运行几步 env.step() + agent.observe() 即可。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary-1">summary<a href="#summary-1" class="hash-link" aria-label="Direct link to summary" title="Direct link to summary">​</a></h2>
<p>4.1 是算法在不同 KPI 下的“目标函数对比实验”；
4.2 是同一算法在不同住宅场景下的“实际储能控制实验”。
针对 TypeError: new():：
在 CityLearn + SAC 中，归一化之所以会出现 None 并报错，是因为强化学习里的智能体（agent）是通过与环境逐步交互来“学习观察数据的分布”，而不是像传统机器学习那样在一开始就加载所有数  据并计算整体均值和标准差。归一化需要用到观测数据的均值和标准差（mean/std），但在训练初期，agent 还没有收集到足够的观测数据，这些归一化参数尚未建立，因此 get_normalized_observations() 返回了 None。也就是说，错误并不是由原始数据或环境造成的，而是因为“agent 还不了解环境的数据分布，却提前尝试对整个环境进行归一化”。解决方法可以是跳过归一化、在训练前进行 warm-up 收集数据以初始化均值和标准差，或使用 centralized agent 等方式。</p>
<h1>Vehicle-to-Grid Control</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-重点与目标">1. 重点与目标<a href="#1-重点与目标" class="hash-link" aria-label="Direct link to 1. 重点与目标" title="Direct link to 1. 重点与目标">​</a></h2>
<p>在 CityLearn 环境中扩展强化学习模型，使得电动汽车不仅能充电，还能在高峰时段将电能回馈给建筑或电网，以实现削峰填谷和整体能耗优化，目标如下</p>
<ol>
<li>将 V2G 机制引入智能电网中的多建筑控制框架；</li>
<li>探究 RL 智能体如何在建筑储能系统与电动汽车电池之间协调能量流动；</li>
<li>目标函数不仅考虑电费最小化，还考虑排放、峰值负荷和舒适度约束。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-环境设置">2. 环境设置<a href="#2-环境设置" class="hash-link" aria-label="Direct link to 2. 环境设置" title="Direct link to 2. 环境设置">​</a></h2>
<p>在 CityLearn 环境中，每栋建筑不仅有 battery 储能系统，还额外配置 EV battery，RL 智能体的动作空间包括：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><msub><mi>a</mi><mtext>building battery</mtext></msub><mo separator="true">,</mo><mtext> </mtext><msub><mi>a</mi><mtext>EV battery</mtext></msub><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">a_t = \left[ a_{\text{building battery}},\ a_{\text{EV battery}} \right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">[</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">building battery</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">EV battery</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em">]</span></span></span></span></span></span>
<p>其中每个<code>a_t</code>都表示充/放电比例；</p>
<ul>
<li>EV 的<strong>可用时间窗口</strong>由住宅用户行为数据确定（车辆通常白天离家、夜晚接入电网）；</li>
<li>充电功率受限于<code>P_{\max}</code>，同时遵守 SoC 上下界约束；</li>
<li>动作经过归一化与裁剪，保证物理可行性。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-奖励函数">3. 奖励函数<a href="#3-奖励函数" class="hash-link" aria-label="Direct link to 3. 奖励函数" title="Direct link to 3. 奖励函数">​</a></h2>
<p>典型形式为：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><mo>−</mo><mi>α</mi><msub><mi>C</mi><mi>t</mi></msub><mo>−</mo><mi>β</mi><msub><mi>E</mi><mi>t</mi></msub><mo>−</mo><mi>γ</mi><msub><mi>P</mi><mrow><mtext>peak</mtext><mo separator="true">,</mo><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">r_t = -\alpha C_t - \beta E_t - \gamma P_{\text{peak},t}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord">−</span><span class="mord mathnormal" style="margin-right:0.0037em">α</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.05278em">β</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em"></span><span class="mord mathnormal" style="margin-right:0.05556em">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">peak</span></span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span></span>
<p>where</p>
<ul>
<li><code>C_t</code>：用电成本；</li>
<li><code>E_t</code>：碳排放；</li>
<li><code>P_{\text{peak},t}</code>：峰值功率；</li>
<li><code>\alpha, \beta, \gamma</code>：权重系数。
通过 V2G，智能体学会在高价时段放电、低价时段充电，从而降低综合成本。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-区别">4. 区别<a href="#4-区别" class="hash-link" aria-label="Direct link to 4. 区别" title="Direct link to 4. 区别">​</a></h2>
<table><thead><tr><th style="text-align:left">对比项</th><th style="text-align:left"><strong>4.1 Baseline Control (RBC/Baseline)</strong></th><th style="text-align:left"><strong>4.2 Reinforcement Learning Control (SAC)</strong></th><th style="text-align:left"><strong>4.3 Vehicle-to-Grid Control (V2G)</strong></th></tr></thead><tbody><tr><td style="text-align:left"><strong>控制对象</strong></td><td style="text-align:left">仅建筑电池 (Building Battery)</td><td style="text-align:left">同上</td><td style="text-align:left">建筑电池 + 电动车电池 (Building + EV Battery)</td></tr><tr><td style="text-align:left"><strong>schema 文件</strong></td><td style="text-align:left"><code>schema.json</code>（基础建筑）</td><td style="text-align:left"><code>schema.json</code>（相同）</td><td style="text-align:left"><code>v2g_schema.json</code> 或 <code>include_ev=True</code></td></tr><tr><td style="text-align:left"><strong>动作空间</strong></td><td style="text-align:left"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub><mo>=</mo><mo stretchy="false">[</mo><msub><mi>a</mi><mrow><mi>b</mi><mi>u</mi><mi>i</mi><mi>l</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>g</mi></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">a_t = [a_{building}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.01968em">l</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">g</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></td><td style="text-align:left">同上</td><td style="text-align:left"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub><mo>=</mo><mo stretchy="false">[</mo><msub><mi>a</mi><mrow><mi>b</mi><mi>u</mi><mi>i</mi><mi>l</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>g</mi></mrow></msub><mo separator="true">,</mo><msub><mi>a</mi><mrow><mi>E</mi><mi>V</mi></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">a_t = [a_{building}, a_{EV}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.01968em">l</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">g</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em">E</span><span class="mord mathnormal mtight" style="margin-right:0.22222em">V</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></td></tr><tr><td style="text-align:left"><strong>状态空间</strong></td><td style="text-align:left">建筑电负荷、太阳能、SoC、电价等</td><td style="text-align:left">同上</td><td style="text-align:left">额外包含 EV SoC、EV 可用时间窗口</td></tr><tr><td style="text-align:left"><strong>强化学习智能体</strong></td><td style="text-align:left">无（规则控制）</td><td style="text-align:left">SAC / PPO</td><td style="text-align:left">SAC（支持 EV 充放电调度）</td></tr><tr><td style="text-align:left"><strong>目标函数</strong></td><td style="text-align:left">最小化电费</td><td style="text-align:left">同上</td><td style="text-align:left">最小化电费 + 排放 + 峰值功率（多目标）</td></tr><tr><td style="text-align:left"><strong>新参数</strong></td><td style="text-align:left">—</td><td style="text-align:left">—</td><td style="text-align:left"><code>v2g=True</code> 或 <code>include_ev=True</code></td></tr><tr><td style="text-align:left"><strong>仿真特点</strong></td><td style="text-align:left">单能系统</td><td style="text-align:left">单能系统 + RL 控制</td><td style="text-align:left">多能系统（建筑 + 车辆 + 电网）</td></tr><tr><td style="text-align:left"><strong>创新点</strong></td><td style="text-align:left">传统控制基线</td><td style="text-align:left">RL 适应性学习</td><td style="text-align:left">RL 扩展到双储能协同优化</td></tr></tbody></table>
<p>一句话概括就是，4.3 在 RL 基础上进一步扩展到“建筑 + 电动车”双储能控制，即 Vehicle-to-Grid (V2G)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-代码">5. 代码<a href="#5-代码" class="hash-link" aria-label="Direct link to 5. 代码" title="Direct link to 5. 代码">​</a></h2>
<p>以 4.1 的 SAC 部分为 baseline，如下</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.citylearn import CityLearnEnv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from citylearn.agents.sac import SAC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from pathlib import Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def run_v2g(agent_class, schema, episodes=3, central_agent=False, save_dir=None, **kwargs):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;\n=== Running {agent_class.__name__} (Vehicle-to-Grid) ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ✅ 启用 include_evs / v2g 参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env = CityLearnEnv(schema, central_agent=central_agent, include_evs=True, **kwargs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent = agent_class(env)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent.learn(episodes=episodes, deterministic_finish=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    results = env.evaluate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(f&quot;✅ {agent_class.__name__} (V2G) finished.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if save_dir:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Path(save_dir).mkdir(parents=True, exist_ok=True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (Path(save_dir)/&quot;metrics.txt&quot;).write_text(str(results))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def main():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ✅ 使用含 EV battery 的 V2G 版本 schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema_v2g = &quot;data/citylearn_challenge_2022/v2g_schema.json&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ✅ 运行 SAC 控制器（Vehicle-to-Grid 实验）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res_v2g = run_v2g(SAC, schema_v2g, episodes=5, central_agent=False, save_dir=&quot;results/4_3_v2g_sac&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;\n=== V2G SAC Results ===&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(res_v2g)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main()</span><br></span></code></pre></div></div>
<h1>Occupant comfort feedback during automated demand response</h1>
<p>貌似复现不出来，因为这是一个基于 CityLearn 的 EULP 数据 + Ecobee DYD 的真实用户统计模型，
构建出的半实数据仿真案例（semi-synthetic simulation）。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-目的">1. 目的<a href="#1-目的" class="hash-link" aria-label="Direct link to 1. 目的" title="Direct link to 1. 目的">​</a></h2>
<p>研究在自动化需量响应（Automated Demand Response, ADR）期间引入住户舒适度反馈机制对整体电力负载与控制性能的影响。
通过引入住户覆盖（override）模型，模拟当用户感到不舒适时回退恒温器设定温度的行为，同时对比不同层次的住户建模复杂度（Level of Detail, LoD 1–3）对能源成本、峰值负载削减以及住户不适次数的影响</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="环境配置">环境配置<a href="#环境配置" class="hash-link" aria-label="Direct link to 环境配置" title="Direct link to 环境配置">​</a></h2>
<table><thead><tr><th>模块</th><th>配置 / 说明</th></tr></thead><tbody><tr><td><strong>CityLearn 版本</strong></td><td>2.4.2（或 ≥ 2.4）</td></tr><tr><td><strong>Python 版本</strong></td><td>3.10+</td></tr><tr><td><strong>强化学习算法</strong></td><td>Soft Actor–Critic (SAC)</td></tr><tr><td><strong>硬件环境</strong></td><td>Ubuntu/macOS, CPU / GPU 可选</td></tr><tr><td><strong>基础数据集</strong></td><td>EULP（Electric Utility Load Profiles, Montréal 冬季）</td></tr><tr><td><strong>住户行为模型</strong></td><td>Ecobee Donate Your Data（DYD）数据训练出的覆盖概率模型</td></tr><tr><td><strong>仿真周期</strong></td><td>冬季三个月（12 月–2 月）</td></tr><tr><td><strong>建筑数量</strong></td><td>10 栋独立住宅</td></tr><tr><td><strong>仿真粒度</strong></td><td>1 小时步长（24×90 steps）</td></tr><tr><td><strong>DR 事件</strong></td><td>工作日 18:00–21:00 设定点下调 1.1°C (≈2°F)</td></tr><tr><td><strong>对照组</strong></td><td>LoD1: 基线，无控制；LoD2: ±2°C 舒适带，RL 控制；LoD3: ±2°C+覆盖模型+DR 事件</td></tr><tr><td><strong>输出指标</strong></td><td>电费成本、峰值功率、总耗电量、覆盖次数与覆盖幅度</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="对比">对比<a href="#对比" class="hash-link" aria-label="Direct link to 对比" title="Direct link to 对比">​</a></h2>
<table><thead><tr><th style="text-align:left">项目</th><th style="text-align:left">4.1 Basic Control</th><th style="text-align:left">4.2 Community Coordination</th><th style="text-align:left">4.3 Multi-Objective (Economic/Emission)</th><th style="text-align:left"><strong>4.4 Comfort Feedback (本节)</strong></th></tr></thead><tbody><tr><td style="text-align:left"><strong>研究重点</strong></td><td style="text-align:left">单建筑基本负载控制</td><td style="text-align:left">多建筑间能量协调</td><td style="text-align:left">多目标权衡（成本 vs 排放）</td><td style="text-align:left">住户舒适反馈与 DR 响应</td></tr><tr><td style="text-align:left"><strong>数据集</strong></td><td style="text-align:left">简化住宅负载</td><td style="text-align:left">社区级 EULP</td><td style="text-align:left">同上</td><td style="text-align:left">同上（+ DYD 行为模型）</td></tr><tr><td style="text-align:left"><strong>控制目标</strong></td><td style="text-align:left">成本最小化</td><td style="text-align:left">成本 + 负载平衡</td><td style="text-align:left">成本 + 排放</td><td style="text-align:left">成本 + 舒适度（减少覆盖次数）</td></tr><tr><td style="text-align:left"><strong>外部信号</strong></td><td style="text-align:left">电价</td><td style="text-align:left">电价</td><td style="text-align:left">电价 + 排放因子</td><td style="text-align:left">电价 + DR 事件</td></tr><tr><td style="text-align:left"><strong>住户模型</strong></td><td style="text-align:left">固定设定温度</td><td style="text-align:left">固定设定温度</td><td style="text-align:left">固定设定温度</td><td style="text-align:left">动态设定温度 + 覆盖行为</td></tr><tr><td style="text-align:left"><strong>LoD (复杂度)</strong></td><td style="text-align:left">LoD1</td><td style="text-align:left">LoD1–2</td><td style="text-align:left">LoD1–2</td><td style="text-align:left">LoD1–3</td></tr><tr><td style="text-align:left"><strong>强化学习结构</strong></td><td style="text-align:left">单智能体 SAC</td><td style="text-align:left">多智能体 SAC</td><td style="text-align:left">多目标 SAC (Reward = αCost + βEmission)</td><td style="text-align:left">多目标 SAC (Reward = αCost + βComfort)</td></tr><tr><td style="text-align:left"><strong>评价指标</strong></td><td style="text-align:left">能耗/成本</td><td style="text-align:left">能耗/峰值</td><td style="text-align:left">成本+排放指标</td><td style="text-align:left">成本+峰值+覆盖次数</td></tr></tbody></table>
<p>总结来说，4.4 在 4.3 基础上加入人的因素（住户舒适反馈）</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/rl">RL</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/yourrepo/blog/26-CityLearn_experiment.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/25-AI classification"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">AI世界大入门</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/assets/25-AI classification"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">AI世界大入门</div></a></nav><div style="margin-top:2rem"></div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#代码路径httpsgithubcomzqqqqqqj1110citylearn_expgit" class="table-of-contents__link toc-highlight">代码路径：https://github.com/zqqqqqqj1110/CityLearn_exp.git</a></li><li><a href="#1-cost-or-emission-reduction" class="table-of-contents__link toc-highlight">1. Cost or Emission Reduction</a><ul><li><a href="#11-实验设置" class="table-of-contents__link toc-highlight">1.1 实验设置</a></li><li><a href="#12-环境" class="table-of-contents__link toc-highlight">1.2 环境</a></li><li><a href="#13-代码" class="table-of-contents__link toc-highlight">1.3 代码</a></li><li><a href="#14-问题汇总" class="table-of-contents__link toc-highlight">1.4 问题汇总</a></li></ul></li><li><a href="#2-peak-reduction" class="table-of-contents__link toc-highlight">2. Peak Reduction</a><ul><li><a href="#21-环境" class="table-of-contents__link toc-highlight">2.1 环境</a></li><li><a href="#22-代码" class="table-of-contents__link toc-highlight">2.2 代码</a></li></ul></li><li><a href="#3-discomfort-and-electricity-consumption-reduction" class="table-of-contents__link toc-highlight">3. Discomfort and Electricity Consumption Reduction</a></li><li><a href="#31-代码" class="table-of-contents__link toc-highlight">3.1 代码</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">summary</a></li><li><a href="#1-重点" class="table-of-contents__link toc-highlight">1. 重点</a></li><li><a href="#2-区别" class="table-of-contents__link toc-highlight">2. 区别</a></li><li><a href="#3-代码" class="table-of-contents__link toc-highlight">3. 代码</a></li><li><a href="#4-报错" class="table-of-contents__link toc-highlight">4. 报错</a><ul><li><a href="#41-assertionerror" class="table-of-contents__link toc-highlight">4.1 AssertionError</a></li><li><a href="#42-typeerror-new-data-must-be-a-sequence-got-nonetype" class="table-of-contents__link toc-highlight">4.2 TypeError: new(): data must be a sequence (got NoneType)</a></li></ul></li><li><a href="#summary-1" class="table-of-contents__link toc-highlight">summary</a></li><li><a href="#1-重点与目标" class="table-of-contents__link toc-highlight">1. 重点与目标</a></li><li><a href="#2-环境设置" class="table-of-contents__link toc-highlight">2. 环境设置</a></li><li><a href="#3-奖励函数" class="table-of-contents__link toc-highlight">3. 奖励函数</a></li><li><a href="#4-区别" class="table-of-contents__link toc-highlight">4. 区别</a></li><li><a href="#5-代码" class="table-of-contents__link toc-highlight">5. 代码</a></li><li><a href="#1-目的" class="table-of-contents__link toc-highlight">1. 目的</a></li><li><a href="#环境配置" class="table-of-contents__link toc-highlight">环境配置</a></li><li><a href="#对比" class="table-of-contents__link toc-highlight">对比</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文档</h4></div><div class="col footer__col"><h4 class="footer__title">社区</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">更多</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/FEMATHS" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>